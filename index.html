<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rave</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
        }
        .scrolling-container::-webkit-scrollbar { width: 8px; }
        .scrolling-container::-webkit-scrollbar-track { background: #000; }
        .scrolling-container::-webkit-scrollbar-thumb { background-color: #444; border-radius: 20px; border: 2px solid #000; }
        .scrolling-container { scrollbar-width: thin; scrollbar-color: #444 #000; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .verification-seal { width: 1rem; height: 1rem; margin-left: 0.25rem; vertical-align: middle; display: inline-block; }
        .skeleton-post { background-color: #1a1a1a; border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; }
        .skeleton-header { display: flex; align-items: center; }
        .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #333; }
        .skeleton-info { margin-left: 0.75rem; }
        .skeleton-line { background-color: #333; border-radius: 0.25rem; height: 12px; }
        .skeleton-line.short { width: 100px; }
        .skeleton-line.long { width: 150px; margin-bottom: 6px; }
        .skeleton-content { margin-top: 1rem; }
        @keyframes skeleton-loading { 0% { background-color: #333; } 50% { background-color: #444; } 100% { background-color: #333; } }
        .skeleton-post > div > div, .skeleton-post .skeleton-line { animation: skeleton-loading 1.5s infinite ease-in-out; }
        .online-indicator { width: 12px; height: 12px; background-color: #22c55e; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid #000; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @keyframes shake-highlight {
            0% { transform: translate(0, 0); box-shadow: 0 0 0 rgba(255, 255, 255, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-2px, 0); }
            20%, 40%, 60%, 80% { transform: translate(2px, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.7); }
            100% { transform: translate(0, 0); box-shadow: 0 0 0 rgba(255, 255, 255, 0); }
        }
        .post-highlight-shake {
            animation: shake-highlight 0.8s ease-in-out;
        }

        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-black text-white p-4">

    <canvas id="particleCanvas"></canvas>

    <div id="initError" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center text-center p-4 hidden">
        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">Erro de Conexão</h2>
        <p class="text-white text-opacity-70">Não foi possível conectar ao servidor. Por favor, verifique sua conexão com a internet e tente novamente mais tarde.</p>
    </div>

    <header class="w-full flex justify-between items-center py-4 relative z-20 flex-shrink-0">
        <button id="profileButton" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors">
            <i class="fas fa-bars text-2xl"></i>
        </button>
        <h1 id="mainHeader" class="text-4xl sm:text-5xl font-extrabold tracking-tight text-white drop-shadow-lg cursor-pointer transition-colors">
            Rave
        </h1>
        <div class="flex space-x-2 items-center">
            <button id="searchButton" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                <i class="fas fa-search text-2xl"></i>
            </button>
            <div class="relative">
                <button id="notificationButton" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors hidden">
                    <i class="fas fa-bell text-2xl"></i>
                    <span id="notificationBadge" class="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
                </button>
            </div>
        </div>
    </header>

    <nav class="flex justify-center space-x-2 my-4 flex-shrink-0">
        <button id="feedTab" class="py-1 px-3 rounded-lg font-semibold text-sm transition-colors duration-200 bg-white text-black">
            Feed
        </button>
        <button id="anonymousTab" class="py-1 px-3 rounded-lg font-semibold text-sm transition-colors duration-200 text-white hover:bg-white hover:bg-opacity-10">
            Anônimos
        </button>
        <button id="trendingTab" class="py-1 px-3 rounded-lg font-semibold text-sm transition-colors duration-200 text-white hover:bg-white hover:bg-opacity-10">
            Em Alta
        </button>
    </nav>
    
    <div id="searchModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 transition-opacity duration-300 hidden">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 flex flex-col space-y-4 border border-white border-opacity-20">
            <button id="closeSearchModal" class="absolute top-4 right-4 text-white hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-lg font-bold">Pesquisar</h3>
             <div class="flex border-b border-gray-700">
                <button id="searchPostsTab" class="flex-1 py-2 text-sm font-semibold border-b-2 border-white text-white">Postagens</button>
                <button id="searchUsersTab" class="flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400">Usuários</button>
            </div>
            <input id="searchBar" type="text" placeholder="Pesquisar por postagens..." class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
            <div id="searchResults" class="w-full max-h-60 overflow-y-auto scrolling-container"></div>
        </div>
    </div>

    <div id="sideMenuOverlay" class="fixed inset-0 z-40 bg-black bg-opacity-90 hidden"></div>
    <div id="sideMenu" class="fixed top-0 left-0 z-50 w-64 h-full bg-black shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-r border-white border-opacity-20">
        <div class="p-6 flex flex-col items-center space-y-4 flex-grow overflow-y-auto scrolling-container">
            <button id="closeSideMenu" class="absolute top-4 right-4 text-white hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div id="profileSection" class="w-full flex flex-col items-center space-y-4">
                <div id="profileImageContainer" class="w-28 h-28 rounded-full bg-white flex items-center justify-center overflow-hidden mt-8">
                    <img id="profileImage" src="" alt="Foto de Perfil" class="w-full h-full object-cover hidden" onerror="this.onerror=null;this.src='https://placehold.co/200x200/000000/FFFFFF?text=?'">
                    <i id="profilePlaceholder" class="fas fa-user text-5xl text-black"></i>
                </div>
                <h2 id="profileNameDisplay" class="text-xl sm:text-2xl font-semibold text-center flex items-center">Carregando...</h2>
                <div class="relative w-full text-center">
                    <button id="copyUidButton" class="w-full p-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition-colors">
                        <p class="text-white text-opacity-50 text-xs">ID: <span id="userIdDisplay" class="text-white break-all font-mono"></span> <i class="fas fa-copy ml-1"></i></p>
                    </button>
                </div>
                
                <div id="loggedInButtons" class="w-full space-y-2 hidden">
                    <button id="editProfileButton" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                        <i class="fas fa-edit mr-2"></i> Editar Perfil
                    </button>
                    <button id="draftsButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                        <i class="fas fa-file-alt mr-2"></i> Rascunhos
                    </button>
                    <button id="verificationButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                        <i class="fas fa-check-circle mr-2"></i> Selo de Verificação
                    </button>
                    <button id="settingsButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                        <i class="fas fa-cog mr-2"></i> Configurações
                    </button>
                    <button id="logoutButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                        <i class="fas fa-sign-out-alt mr-2"></i> Sair
                    </button>
                </div>

                <button id="loginSignupButton" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95 mt-4">
                    <i class="fas fa-sign-in-alt mr-2"></i> Entrar / Criar Conta
                </button>

                <button id="rulesButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95 mt-4">
                    <i class="fas fa-gavel mr-2"></i> Regras do App
                </button>

                <!-- Nova seção Parcerias adicionada -->
                <div id="partnershipsSection" class="w-full space-y-2 mt-4">
                    <button id="partnershipsButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                        <i class="fas fa-handshake mr-2"></i> Parcerias
                    </button>
                </div>
                
                <div id="downloadAppSection" class="w-full space-y-2 mt-4">
                    <h3 class="text-sm font-semibold text-white text-center">Baixe o Rave</h3>
                    <a href="https://play.google.com/store/apps/details?id=com.wemesh.android&hl=pt" target="_blank" rel="noopener noreferrer" class="w-full bg-green-500 text-white font-semibold py-3 rounded-xl flex items-center justify-center transition-all hover:bg-green-600 active:scale-95">
                        <i class="fab fa-google-play mr-2"></i> Android
                    </a>
                    <a href="https://apps.apple.com/app/rave-watch-party/id929775122" target="_blank" rel="noopener noreferrer" class="w-full bg-white text-black font-semibold py-3 rounded-xl flex items-center justify-center transition-all hover:bg-gray-200 active:scale-95">
                        <i class="fab fa-app-store-ios mr-2"></i> iOS
                    </a>
                </div>
            </div>
        </div>
        <div class="mt-auto p-4 text-center text-xs text-white text-opacity-50 border-t border-white border-opacity-20 w-full">
            versão 1 | 2025
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 flex flex-col space-y-4 border border-white border-opacity-20">
             <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Configurações</h3>
                <button id="closeSettingsModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="w-full space-y-2">
                 <button id="editProfileCardButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                    <i class="fas fa-address-card mr-2"></i> Editar Card
                </button>
                <button id="changePasswordButton" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                    <i class="fas fa-key mr-2"></i> Trocar Senha
                </button>
                <button id="deleteProfileButton" class="w-full bg-red-500 bg-opacity-20 text-red-400 font-semibold py-3 rounded-xl transition-all hover:bg-opacity-30 active:scale-95">
                    <i class="fas fa-trash-alt mr-2"></i> Excluir Perfil
                </button>
            </div>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20">
            <div class="flex justify-between items-center">
                <h3 id="authModalTitle" class="text-xl font-bold">Entrar</h3>
                <button id="closeAuthModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="authErrorMessage" class="text-red-400 text-sm text-center hidden p-2 bg-red-500 bg-opacity-10 rounded-lg"></div>
            <input id="authEmail" type="email" placeholder="Email" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
            <div class="relative w-full">
                <input id="authPassword" type="password" placeholder="Senha" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                <button id="togglePassword" class="absolute inset-y-0 right-0 px-3 flex items-center text-white text-opacity-50">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <button id="authSubmitButton" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                Entrar
            </button>
            <p class="text-center text-sm text-white text-opacity-50">
                <span id="authToggleText">Não tem uma conta?</span>
                <button id="authToggleButton" class="font-semibold text-white hover:underline">Crie uma aqui.</button>
            </p>
        </div>
    </div>
    
    <div id="changePasswordModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 flex flex-col space-y-4 border border-white border-opacity-20">
            <button id="closeChangePasswordModal" class="absolute top-4 right-4 text-white hover:text-white transition-colors"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-lg font-bold">Trocar Senha </h3>
            <div id="changePasswordMessage" class="text-sm text-center hidden p-2 rounded-lg"></div>
            <input id="newPasswordInput" type="password" placeholder="Nova Senha" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white">
            <button id="saveNewPassword" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">Salvar Nova Senha</button>
        </div>
    </div>

    <div id="deleteConfirmationModal" class="fixed inset-0 z-[70] bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="bg-black rounded-2xl p-6 w-11/12 sm:w-1/2 md:w-1/3 lg:w-1/4 flex flex-col items-center text-center space-y-4 border border-white border-opacity-20">
            <p id="confirmationModalText" class="text-lg font-semibold">Tem certeza?</p>
            <div class="flex space-x-4 w-full">
                <button id="confirmDelete" class="w-1/2 bg-red-500 text-white py-2 rounded-xl transition-all hover:bg-red-600 active:scale-95">Confirmar</button>
                <button id="cancelDelete" class="w-1/2 bg-white bg-opacity-10 text-white py-2 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">Cancelar</button>
            </div>
        </div>
    </div>


    <div id="profileEditModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 transition-opacity duration-300 hidden">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 flex flex-col items-center space-y-4 border border-white border-opacity-20">
            <button id="closeProfileEditModal" class="absolute top-4 right-4 text-white hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-lg font-bold">Editar Perfil</h3>
            <div class="w-28 h-28 rounded-full bg-white flex items-center justify-center overflow-hidden">
                <img id="profilePreviewImage" src="https://placehold.co/200x200/000000/FFFFFF?text=?" class="w-full h-full object-cover">
            </div>
            <input id="profileNameInput" type="text" placeholder="Seu nome de usuário" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
            <div class="relative w-full">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-white text-opacity-50">@</span>
                <input id="profileUsernameInput" type="text" placeholder="Seu @username" class="w-full p-3 pl-8 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                <span id="usernameStatus" class="absolute right-3 top-1/2 -translate-y-1/2"></span>
            </div>
            <label for="profileImageFile" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg cursor-pointer flex items-center justify-center space-x-2 hover:bg-opacity-20 transition-colors">
                <i class="fas fa-image"></i>
                <span id="profileFileName">Selecionar Imagem</span>
            </label>
            <input id="profileImageFile" type="file" accept="image/*,image/gif" class="hidden">
            <div id="profileUploadProgress" class="text-center text-white text-opacity-50 text-sm hidden"></div>
            <button id="saveProfile" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95 mt-4">
                Salvar Perfil
            </button>
        </div>
    </div>
    
    <div id="notificationModal" class="fixed inset-0 z-[60] bg-black bg-opacity-90 transition-opacity duration-300 hidden">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 flex flex-col space-y-4 border border-white border-opacity-20 max-h-[80vh]">
            <button id="closeNotificationModal" class="absolute top-4 right-4 text-white hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-lg font-bold">Notificações</h3>
            <div id="notificationList" class="overflow-y-auto scrolling-container space-y-3">
                <p class="text-center text-white text-opacity-50">Nenhuma notificação por enquanto.</p>
            </div>
        </div>
    </div>

    <!-- Novo Modal de Parcerias -->
    <div id="partnershipsModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20 max-h-[80vh] overflow-y-auto scrolling-container">
            <button id="closePartnershipsModal" class="absolute top-4 right-4 text-white hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-lg font-bold text-center">Parcerias</h3>
            <div class="text-center text-sm text-white text-opacity-80 space-y-2">
                <p>Nos envie sua proposta!</p>
                <div class="flex items-center justify-center space-x-2">
                    <p id="partnershipEmail" class="font-semibold">ravezzeiross@gmail.com</p>
                    <button id="copyEmailButton" class="p-1 rounded-full text-white bg-white bg-opacity-10 hover:bg-opacity-20 transition-colors">
                        <i class="fas fa-copy text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="w-full text-white text-opacity-70 space-y-3">
                <p class="font-semibold text-white">Estamos abertos para propostas de:</p>
                <ul class="list-disc list-inside space-y-2">
                    <li>Divulgação de redes sociais</li>
                    <li>Links de salas no Rave</li>
                    <li>Sites de filmes para o Rave</li>
                    <li>Entre outros tipos de colaboração!</li>
                </ul>
            </div>
        </div>
    </div>


    <div id="rulesModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 transition-opacity duration-300 hidden flex items-center justify-center">
        <div class="relative w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 flex flex-col space-y-4 border border-white border-opacity-20 max-h-[80vh] overflow-y-auto scrolling-container">
            <button id="closeRulesModal" class="absolute top-4 right-4 text-white hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-lg font-bold text-center">Regras do App</h3>
            <ul class="text-white text-opacity-80 space-y-3 list-disc list-inside">
                <li><strong class="text-white">Apenas usuários cadastrados</strong> podem criar postagens e comentários. Usuários anônimos podem apenas visualizar e curtir.</li>
                <li><strong class="text-white">Respeito é a base de tudo.</strong> Não toleramos ofensas, assédio, discurso de ódio ou qualquer tipo de preconceito (racismo, homofobia, etc.).</li>
                <li><strong class="text-white">Conteúdo sensível é proibido.</strong> Nada de pornografia, violência explícita ou qualquer conteúdo ilegal.</li>
                <li><strong class="text-white">Sem spam e fake news.</strong> Não permitimos a divulgação de propagandas, links maliciosos ou desinformação que possa prejudicar outros.</li>
                <li><strong class="text-white">Proteja a privacidade.</strong> É proibido compartilhar informações pessoais de outras pessoas sem consentimento.</li>
                <li><strong class="text-white">Use o bom senso.</strong> O objetivo é criar uma comunidade segura e divertida. Contribua positivamente.</li>
                <li><strong class="text-white">Denuncie.</strong> Se você ver alguém quebrando as regras, use a função de denúncia para nos avisar.</li>
            </ul>
        </div>
    </div>

    <main id="app-container" class="w-full flex-grow flex flex-col items-center overflow-hidden relative">
        <div id="newPostNotification" class="w-full max-w-lg mt-4 hidden z-30 absolute top-0">
             <button id="showNewPostsBtn" class="w-full bg-white text-black font-semibold py-2 px-4 rounded-lg shadow-lg transition-transform hover:scale-105 active:scale-95">
                Ver novos posts
            </button>
        </div>

        <div id="feed" class="w-full max-w-lg space-y-4 overflow-y-auto scrolling-container h-full pt-4">
            <!-- As postagens serão injetadas aqui -->
        </div>
        <div id="feed-end-message" class="text-center text-white text-opacity-50 py-8 hidden"><p>Você chegou ao fim.</p></div>
    </main>
    
    <div id="badgeNotification" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full shadow-lg transition-transform duration-300 transform scale-0 origin-bottom z-50">
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
            <p class="font-semibold text-sm">Sua solicitação foi aprovada!</p>
            <button id="acceptBadgeButton" class="bg-black text-white px-3 py-1 rounded-full font-bold text-xs hover:bg-gray-800 transition-colors">
                Obter Selo
            </button>
        </div>
    </div>


    <button id="backToTopBtn" class="fixed bottom-24 right-6 z-40 w-12 h-12 rounded-full bg-white bg-opacity-20 text-white hidden items-center justify-center shadow-lg backdrop-blur-sm hover:bg-opacity-30">
        <i class="fas fa-arrow-up"></i>
    </button>
    <button id="postFab" class="fixed bottom-6 right-6 z-40 w-16 h-16 rounded-full bg-white text-black flex items-center justify-center shadow-lg transition-transform hover:scale-110 active:scale-90" style="display: none;">
        <i class="fas fa-plus text-3xl"></i>
    </button>

    <div id="postModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 transition-opacity duration-300 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20">
            <div class="flex justify-between items-center">
                <h3 id="postModalTitle" class="text-xl font-bold">Nova Postagem</h3>
                <button id="closePostModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <textarea id="postContent" class="w-full p-3 h-32 bg-white bg-opacity-10 text-white rounded-lg resize-none placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors" placeholder="O que está na sua mente?"></textarea>
            
            <div id="postImagePreviewContainer" class="w-full h-40 bg-white bg-opacity-10 rounded-lg overflow-hidden hidden">
                <img id="postImagePreview" src="" class="w-full h-full object-contain">
            </div>

            <label for="postImageFile" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg cursor-pointer flex items-center justify-center space-x-2 hover:bg-opacity-20 transition-colors">
                <i class="fas fa-image"></i>
                <span id="postFileName">Selecionar Mídia (Imagem ou GIF)</span>
            </label>
            <input id="postImageFile" type="file" accept="image/*,image/gif" class="hidden">
            <div id="postUploadProgress" class="text-center text-white text-opacity-50 text-sm hidden"></div>
            <div id="postFileWarning" class="text-center text-xs text-yellow-400 hidden"></div>
            <div class="flex space-x-2">
                <button id="saveDraft" class="w-full bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">
                    Salvar Rascunho
                </button>
                <button id="submitPost" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                    Publicar
                </button>
            </div>
            <div id="postLimitMessage" class="text-center text-xs text-yellow-400"></div>
        </div>
    </div>
    
    <div id="editPostModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 transition-opacity duration-300 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Editar Postagem</h3>
                <button id="closeEditPostModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <textarea id="editPostContent" class="w-full p-3 h-32 bg-white bg-opacity-10 text-white rounded-lg resize-none placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors"></textarea>
            <input id="editPostLink" type="url" placeholder="Editar link (opcional)" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
            <div id="editPostImageContainer" class="relative">
                <img id="editPostImagePreview" src="" class="w-full h-40 object-contain rounded-lg">
                <button id="removeEditImage" class="absolute top-2 right-2 bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center text-white">&times;</button>
            </div>
            <label for="editPostImageFile" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg cursor-pointer flex items-center justify-center space-x-2 hover:bg-opacity-20 transition-colors">
                <i class="fas fa-image"></i>
                <span>Trocar Imagem</span>
            </label>
            <input id="editPostImageFile" type="file" accept="image/*,image/gif" class="hidden">
            <div id="editPostFileWarning" class="text-center text-xs text-yellow-400 hidden"></div>
            <button id="saveEditedPost" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                Salvar Alterações
            </button>
        </div>
    </div>
    
    <div id="editCommentModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 transition-opacity duration-300 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Editar Comentário</h3>
                <button id="closeEditCommentModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <textarea id="editCommentContent" class="w-full p-3 h-24 bg-white bg-opacity-10 text-white rounded-lg resize-none placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors"></textarea>
            <button id="saveEditedComment" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                Salvar Alterações
            </button>
        </div>
    </div>

    <div id="profileCardPage" class="fixed inset-0 z-[60] bg-black hidden overflow-y-auto scrolling-container w-screen p-4">
        <div class="max-w-lg mx-auto">
            <div class="flex justify-between items-center mb-4">
                <button id="closeProfileCardPage" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h2 id="cardUsernameTop" class="text-lg font-bold"></h2>
                <button id="shareProfileButton" class="text-white p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition-colors">
                    <i class="fas fa-share-alt text-lg"></i>
                </button>
            </div>

            <div id="cardHeader" class="relative w-full h-32 sm:h-40 bg-white bg-opacity-10 rounded-xl overflow-hidden">
                <img id="cardHeaderImage" src="" class="absolute inset-0 w-full h-full object-cover">
            </div>
             <div class="relative -mt-12 z-10 flex flex-col items-center">
                <div id="cardProfileImageContainer" class="w-24 h-24 rounded-full border-4 border-black bg-white flex items-center justify-center overflow-hidden">
                    <img id="cardProfileImage" src="" class="w-full h-full object-cover hidden">
                    <i id="cardProfilePlaceholder" class="fas fa-user text-4xl text-black"></i>
                </div>
            </div>
            
            <div class="p-4 pt-2 text-center w-full">
                <h2 id="cardProfileName" class="text-2xl font-bold flex justify-center items-center"></h2>
                <p id="cardBio" class="text-sm text-white text-opacity-80 mt-3 break-words max-w-lg mx-auto"></p>
                <div id="socialLinksContainer" class="flex justify-center items-center space-x-4 mt-4"></div>
                
                <button id="aboutButton" class="mt-4 text-xs bg-white bg-opacity-10 text-white font-semibold py-1 px-3 rounded-full hover:bg-opacity-20 transition-colors">
                    Sobre <i class="fas fa-chevron-down ml-1 transition-transform text-xs"></i>
                </button>
                <div id="aboutDetails" class="hidden mt-3 text-sm text-white text-opacity-70 max-w-lg mx-auto p-3 bg-white bg-opacity-5 rounded-lg">
                    <div class="grid grid-cols-2 gap-2 text-left">
                        <div id="cardPronouns"></div>
                        <div id="cardGender"></div>
                        <div id="cardSexuality"></div>
                        <div id="cardAge"></div>
                        <div id="cardZodiac"></div>
                        <div id="cardRelationshipStatus"></div>
                        <div id="cardPersonality" class="col-span-2"></div>
                    </div>
                </div>

                <div class="flex justify-center items-center space-x-8 mt-4">
                    <button id="followersButton" class="text-center">
                        <p id="followerCount" class="text-lg font-bold">0</p>
                        <p class="text-xs text-white text-opacity-50">seguidores</p>
                    </button>
                      <div class="text-center">
                        <p id="postCount" class="text-lg font-bold">0</p>
                        <p class="text-xs text-white text-opacity-50">posts</p>
                    </div>
                </div>
                <button id="followButton" class="w-full max-w-xs mx-auto mt-4 bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                    <i class="fas fa-user-plus mr-2"></i> Seguir
                </button>
            </div>
            
            <div class="w-full max-w-lg mx-auto px-4">
                <div class="flex space-x-4 border-b border-white border-opacity-10">
                    <button id="cardFeedTab" class="flex-1 py-2 text-sm font-semibold border-b-2 border-white text-white">Feed</button>
                    <button id="cardPostsTab" class="flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400">Postagens</button>
                </div>
            </div>

            <div id="profileCardContent">
                <div id="cardFeedContent" class="w-full max-w-lg mx-auto">
                    <div id="additionalPhotosContainer" class="p-4 w-full mx-auto hidden">
                        <div id="photosWrapper" class="grid grid-cols-3 gap-2"></div>
                    </div>
                </div>
                <div id="cardPostsContent" class="w-full max-w-lg mx-auto hidden">
                    <div id="userPostsFeed" class="w-full mx-auto py-4 space-y-4">
                    </div>
                    <div id="user-posts-end-message" class="text-center text-white text-opacity-50 py-8 hidden"><p>Fim das postagens.</p></div>
                </div>
            </div>
        </div>
    </div>


    <div id="editProfileCardPage" class="fixed inset-0 z-[70] bg-black transition-opacity duration-300 hidden flex flex-col">
        <header class="w-full flex justify-between items-center py-4 px-6 relative z-20 flex-shrink-0">
            <button id="backFromEditCardPage" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                <i class="fas fa-arrow-left text-2xl"></i>
            </button>
            <h1 class="text-lg font-bold">Editar Card do Perfil</h1>
            <div></div> </header>
        <div class="flex-grow overflow-y-auto scrolling-container">
            <div class="flex flex-col items-center p-6 space-y-4">
                <div class="w-full h-40 bg-white bg-opacity-10 rounded-xl overflow-hidden relative">
                    <img id="editCardHeaderPreview" src="" class="w-full h-full object-cover">
                    <label for="editCardHeaderFile" class="absolute inset-0 cursor-pointer flex items-center justify-center bg-black bg-opacity-50 hover:bg-opacity-70 transition-colors">
                        <i class="fas fa-camera text-2xl text-white"></i>
                    </label>
                    <input id="editCardHeaderFile" type="file" accept="image/*,image/gif" class="hidden" data-preview="editCardHeaderPreview">
                </div>
                <div class="w-24 h-24 rounded-full bg-white flex items-center justify-center overflow-hidden relative -mt-12 z-10 border-4 border-black">
                    <img id="editCardProfilePreview" src="" class="w-full h-full object-cover">
                    <label for="editCardProfileFile" class="absolute w-full h-full rounded-full cursor-pointer flex items-center justify-center bg-black bg-opacity-50 hover:bg-opacity-70 transition-colors">
                         <i class="fas fa-camera text-xl text-white"></i>
                    </label>
                    <input id="editCardProfileFile" type="file" accept="image/*,image/gif" class="hidden" data-preview="editCardProfilePreview">
                </div>

                <textarea id="editCardBio" placeholder="Sua bio (opcional)" class="w-full p-3 h-24 bg-white bg-opacity-10 text-white rounded-lg resize-none placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors resize-none" maxlength="150"></textarea>

                <input id="editCardPronouns" type="text" placeholder="Pronomes (ex: ele/dele)" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">

                <select id="editCardGender" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <option value="" disabled selected>Gênero</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                    <option value="Não-binário">Não-binário</option>
                    <option value="Homem Trans">Homem Trans</option>
                    <option value="Mulher Trans">Mulher Trans</option>
                    <option value="Outro">Outro</option>
                    <option value="Prefiro não dizer">Prefiro não dizer</option>
                </select>
                
                <select id="editCardSexuality" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <option value="" disabled selected>Sexualidade</option>
                    <option value="Hetero">Hetero</option>
                    <option value="Gay">Gay</option>
                    <option value="Lésbica">Lésbica</option>
                    <option value="Bissexual">Bissexual</option>
                    <option value="Assexual">Assexual</option>
                    <option value="Pansexual">Pansexual</option>
                    <option value="Outro">Outro</option>
                    <option value="Prefiro não dizer">Prefiro não dizer</option>
                </select>

                <input id="editCardAge" type="number" placeholder="Idade" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors" required min="1">

                <select id="editCardRelationship" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <option value="" disabled selected>Status de Relacionamento</option>
                    <option value="Solteiro(a)">Solteiro(a)</option>
                    <option value="Em um relacionamento">Em um relacionamento</option>
                    <option value="Casado(a)">Casado(a)</option>
                    <option value="É complicado">É complicado</option>
                    <option value="Prefiro não dizer">Prefiro não dizer</option>
                </select>

                <input id="editCardZodiac" type="text" placeholder="Signo do Zodíaco" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                <input id="editCardPersonality" type="text" placeholder="Personalidade (MBTI, etc.)" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">

                <div class="w-full space-y-2">
                    <p class="text-sm text-white text-opacity-70">Redes Sociais (opcional):</p>
                    <div class="relative">
                        <i class="fab fa-instagram absolute left-3 top-1/2 -translate-y-1/2 text-white text-opacity-50"></i>
                        <input id="editCardInstagram" type="text" placeholder="usuario_instagram" class="w-full p-3 pl-10 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    </div>
                    <div class="relative">
                        <i class="fab fa-tiktok absolute left-3 top-1/2 -translate-y-1/2 text-white text-opacity-50"></i>
                        <input id="editCardTiktok" type="text" placeholder="@usuario_tiktok" class="w-full p-3 pl-10 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    </div>
                </div>
                
                <div class="w-full space-y-2">
                    <p class="text-sm text-white text-opacity-70">Fotos adicionais (opcional):</p>
                    <div id="editCardPhotosGrid" class="grid grid-cols-3 gap-2">
                        <!-- Photo inputs will be generated by JS -->
                    </div>
                </div>

                <div id="cardUploadProgress" class="text-center text-white text-opacity-50 text-sm hidden"></div>
                <button id="saveProfileCard" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95 mt-4">
                    Salvar Card
                </button>
            </div>
        </div>
    </div>

    <div id="draftsModal" class="fixed inset-0 z-50 bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20 max-h-[80vh]">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Meus Rascunhos</h3>
                <button id="closeDraftsModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="draftsList" class="overflow-y-auto scrolling-container space-y-3">
            </div>
        </div>
    </div>

    <div id="verificationPage" class="fixed inset-0 z-50 bg-black hidden flex flex-col h-screen">
        <header class="w-full flex justify-between items-center py-4 px-4 sticky top-0 bg-black z-10">
            <button id="backFromVerificationPage" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                <i class="fas fa-arrow-left text-2xl"></i>
            </button>
            <h1 class="text-lg font-bold">Selo de Verificação</h1>
            <div></div> 
        </header>
        <div class="flex-grow overflow-y-auto scrolling-container p-4">
            <div class="max-w-lg mx-auto">
                <div id="verificationStatusMessage" class="hidden text-center p-4 rounded-lg font-semibold"></div>
                
                <div id="verificationFormContainer" class="space-y-4">
                    <h3 class="text-xl font-bold text-center">Solicitar Selo</h3>
                    <div class="p-4 bg-white bg-opacity-10 rounded-lg text-sm">
                        <p class="font-bold mb-2">Requisitos:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Ser um usuário ativo na plataforma.</li>
                            <li>Respeitar todas as regras da comunidade.</li>
                        </ul>
                    </div>
                    <input id="verificationName" type="text" placeholder="Nome completo *" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <input id="verificationAge" type="number" placeholder="Idade *" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <input id="verificationWhatsapp" type="tel" placeholder="WhatsApp para contato *" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <textarea id="verificationReason" placeholder="Por que você quer ganhar o selo? *" class="w-full p-3 h-24 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors resize-none"></textarea>
                    
                    <label for="verificationImageFile" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg cursor-pointer flex items-center justify-center space-x-2 hover:bg-opacity-20 transition-colors">
                        <i class="fas fa-camera"></i>
                        <span id="verificationImageName">Enviar uma foto para confirmação de identidade *</span>
                    </label>
                    <input id="verificationImageFile" type="file" accept="image/*" class="hidden">
                    <div id="verificationImagePreviewContainer" class="w-full flex justify-center items-center hidden">
                        <img id="verificationImagePreview" src="" class="max-w-full max-h-48 rounded-lg object-contain">
                    </div>

                    <button id="submitVerificationRequest" class="w-full bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                        Enviar Solicitação
                    </button>
                </div>
                
                <div class="mt-8 pt-6 border-t border-white border-opacity-20">
                    <h4 class="text-center font-semibold mb-3">Já tem um código?</h4>
                    <div class="flex space-x-2">
                        <input id="verificationCodeInput" type="text" placeholder="Digite o código" class="w-full p-3 bg-white bg-opacity-10 text-white rounded-lg placeholder-white focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                        <button id="submitVerificationCode" class="p-3 bg-white text-black rounded-xl font-semibold transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">
                            Verificar
                        </button>
                    </div>
                    <p id="verificationCodeFeedback" class="text-center text-sm mt-3 h-4"></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="adminModal" class="fixed inset-0 z-60 bg-black hidden flex flex-col h-screen">
        <header class="w-full flex justify-between items-center py-4 px-4 sticky top-0 bg-black z-10">
            <button id="backFromAdminPage" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                <i class="fas fa-arrow-left text-2xl"></i>
            </button>
            <h1 class="text-lg font-bold">Painel de Administração</h1>
            <button id="refreshAdminData" class="p-2 rounded-full text-white hover:bg-white hover:bg-opacity-10 transition-colors">
                <i class="fas fa-sync-alt text-xl"></i>
            </button>
        </header>
        <div class="flex-grow overflow-y-auto scrolling-container p-4">
            <div class="max-w-lg mx-auto space-y-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">Solicitações Pendentes</h3>
                    <div id="pendingRequestsList" class="space-y-4">
                        <p class="text-center text-white text-opacity-50">Carregando...</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Usuários Verificados</h3>
                    <div id="verifiedUsersList" class="space-y-4">
                        <p class="text-center text-white text-opacity-50">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="lightboxModal" class="fixed inset-0 z-[80] bg-black bg-opacity-90 hidden items-center justify-center">
        <button id="closeLightbox" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
        <img id="lightboxImage" src="" class="max-w-[90vw] max-h-[90vh] object-contain">
    </div>

    <div id="followersModal" class="fixed inset-0 z-[70] bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="w-11/12 sm:w-2/3 md:w-1/2 lg:w-1/3 bg-black rounded-2xl p-6 shadow-2xl flex flex-col space-y-4 border border-white border-opacity-20 max-h-[80vh]">
            <div class="flex justify-between items-center">
                <h3 id="followersModalTitle" class="text-xl font-bold">Seguidores</h3>
                <button id="closeFollowersModal" class="text-white hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="followersList" class="overflow-y-auto scrolling-container space-y-3">
            </div>
        </div>
    </div>

    <div id="discardPostModal" class="fixed inset-0 z-[70] bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="bg-black rounded-2xl p-6 w-11/12 sm:w-1/2 md:w-1/3 lg:w-1/4 flex flex-col items-center text-center space-y-4 border border-white border-opacity-20">
            <p class="text-lg font-semibold">Descartar postagem?</p>
            <p class="text-sm text-white text-opacity-70">Seu progresso será perdido. Você também pode salvar como rascunho.</p>
            <div class="flex flex-col space-y-2 w-full">
                <button id="confirmDiscard" class="w-full bg-red-500 text-white py-2 rounded-xl transition-all hover:bg-red-600 active:scale-95">Descartar</button>
                <button id="saveDraftAndClose" class="w-full bg-white text-black py-2 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95">Salvar Rascunho</button>
                <button id="cancelDiscard" class="w-full bg-white bg-opacity-10 text-white py-2 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="profileActionModal" class="fixed inset-0 z-[70] bg-black bg-opacity-90 hidden flex items-center justify-center">
        <div class="bg-black rounded-2xl p-6 w-11/12 sm:w-1/2 md:w-1/3 lg:w-1/4 flex flex-col items-center text-center space-y-4 border border-white border-opacity-20">
            <p class="text-lg font-semibold">O que você quer ver?</p>
            <div class="flex flex-col space-y-2 w-full">
                <button id="viewProfilePhoto" class="w-full bg-white bg-opacity-10 text-white py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">Ver Foto de Perfil</button>
                <button id="viewProfileCard" class="w-full bg-white bg-opacity-10 text-white py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">Ver Card do Perfil</button>
                <button id="cancelProfileAction" class="w-full mt-4 text-white text-opacity-70 py-2 rounded-xl transition-all hover:bg-opacity-20 active:scale-95">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="copyFeedback" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-500 text-white text-sm px-4 py-2 rounded-full hidden z-[100]">Link copiado!</div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updatePassword,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            serverTimestamp, 
            orderBy, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            deleteDoc,
            limit,
            startAfter,
            getDocs,
            where,
            increment,
            runTransaction,
            Timestamp,
            collectionGroup,
            writeBatch,
            getCountFromServer
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyClnvjH-W80zdeoV34_lWZ-SF-HdZ31aHw",
          authDomain: "fofocandorave.firebaseapp.com",
          projectId: "fofocandorave",
          storageBucket: "fofocandorave.appspot.com",
          messagingSenderId: "161999330000",
          appId: "1:161999330000:web:ce533405caef21f7845cd5"
        };
        
        const appId = 'rave-app-producao';
        const imgbbApiKey = "9a792281a6220ed358215ad0c1e4162e";
        const verificationSealUrl = 'https://img.icons8.com/?size=512&id=2sZ0sdlG9kWP&format=png';

        let app, db, auth;
        
        const mainHeader = document.getElementById('mainHeader');
        const profileButton = document.getElementById('profileButton');
        const searchButton = document.getElementById('searchButton');
        const notificationButton = document.getElementById('notificationButton');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationModal = document.getElementById('notificationModal');
        const notificationList = document.getElementById('notificationList');
        const closeNotificationModal = document.getElementById('closeNotificationModal');
        const searchModal = document.getElementById('searchModal');
        const closeSearchModal = document.getElementById('closeSearchModal');
        const searchBar = document.getElementById('searchBar');
        const searchResults = document.getElementById('searchResults');
        const searchPostsTab = document.getElementById('searchPostsTab');
        const searchUsersTab = document.getElementById('searchUsersTab');
        const postModal = document.getElementById('postModal');
        const postFab = document.getElementById('postFab');
        const closePostModal = document.getElementById('closePostModal');
        const submitPost = document.getElementById('submitPost');
        const saveDraft = document.getElementById('saveDraft');
        const postContent = document.getElementById('postContent');
        const postImageFile = document.getElementById('postImageFile');
        const postFileName = document.getElementById('postFileName');
        const postUploadProgress = document.getElementById('postUploadProgress');
        const postImagePreviewContainer = document.getElementById('postImagePreviewContainer');
        const postImagePreview = document.getElementById('postImagePreview');
        const postLimitMessage = document.getElementById('postLimitMessage');
        const postFileWarning = document.getElementById('postFileWarning');
        const feed = document.getElementById('feed');
        const feedEndMessage = document.getElementById('feed-end-message');
        const feedTab = document.getElementById('feedTab');
        const anonymousTab = document.getElementById('anonymousTab');
        const trendingTab = document.getElementById('trendingTab');
        const postModalTitle = document.getElementById('postModalTitle');
        const sideMenu = document.getElementById('sideMenu');
        const sideMenuOverlay = document.getElementById('sideMenuOverlay');
        const closeSideMenu = document.getElementById('closeSideMenu');
        const editProfileButton = document.getElementById('editProfileButton');
        const rulesButton = document.getElementById('rulesButton');
        const draftsButton = document.getElementById('draftsButton');
        const partnershipsButton = document.getElementById('partnershipsButton');
        const partnershipsModal = document.getElementById('partnershipsModal');
        const closePartnershipsModal = document.getElementById('closePartnershipsModal');
        const copyEmailButton = document.getElementById('copyEmailButton');
        const partnershipEmail = document.getElementById('partnershipEmail');
        const profileEditModal = document.getElementById('profileEditModal');
        const closeProfileEditModal = document.getElementById('closeProfileEditModal');
        const profileImage = document.getElementById('profileImage');
        const profilePlaceholder = document.getElementById('profilePlaceholder');
        const profilePreviewImage = document.getElementById('profilePreviewImage');
        const profileNameDisplay = document.getElementById('profileNameDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const copyUidButton = document.getElementById('copyUidButton');
        const copyFeedback = document.getElementById('copyFeedback');
        const profileNameInput = document.getElementById('profileNameInput');
        const profileUsernameInput = document.getElementById('profileUsernameInput');
        const usernameStatus = document.getElementById('usernameStatus');
        const profileImageFile = document.getElementById('profileImageFile');
        const profileFileName = document.getElementById('profileFileName');
        const profileUploadProgress = document.getElementById('profileUploadProgress');
        const saveProfile = document.getElementById('saveProfile');
        const rulesModal = document.getElementById('rulesModal');
        const closeRulesModal = document.getElementById('closeRulesModal');
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const confirmationModalText = document.getElementById('confirmationModalText');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const editPostModal = document.getElementById('editPostModal');
        const closeEditPostModal = document.getElementById('closeEditPostModal');
        const editPostContent = document.getElementById('editPostContent');
        const editPostLink = document.getElementById('editPostLink');
        const editPostImageContainer = document.getElementById('editPostImageContainer');
        const editPostImagePreview = document.getElementById('editPostImagePreview');
        const removeEditImage = document.getElementById('removeEditImage');
        const editPostImageFile = document.getElementById('editPostImageFile');
        const editPostFileWarning = document.getElementById('editPostFileWarning');
        const saveEditedPost = document.getElementById('saveEditedPost');
        const editCommentModal = document.getElementById('editCommentModal');
        const closeEditCommentModal = document.getElementById('closeEditCommentModal');
        const editCommentContent = document.getElementById('editCommentContent');
        const saveEditedComment = document.getElementById('saveEditedComment');
        const loggedInButtons = document.getElementById('loggedInButtons');
        const loginSignupButton = document.getElementById('loginSignupButton');
        const logoutButton = document.getElementById('logoutButton');
        const authModal = document.getElementById('authModal');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const togglePassword = document.getElementById('togglePassword');
        const authSubmitButton = document.getElementById('authSubmitButton');
        const authToggleText = document.getElementById('authToggleText');
        const authToggleButton = document.getElementById('authToggleButton');
        const authErrorMessage = document.getElementById('authErrorMessage');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const closeChangePasswordModal = document.getElementById('closeChangePasswordModal');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const saveNewPassword = document.getElementById('saveNewPassword');
        const changePasswordMessage = document.getElementById('changePasswordMessage');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const changePasswordButton = settingsModal.querySelector('#changePasswordButton');
        const deleteProfileButton = settingsModal.querySelector('#deleteProfileButton');
        const editProfileCardButton = settingsModal.querySelector('#editProfileCardButton');
        const profileCardPage = document.getElementById('profileCardPage');
        const closeProfileCardPage = document.getElementById('closeProfileCardPage');
        const cardHeaderImage = document.getElementById('cardHeaderImage');
        const cardProfileImage = document.getElementById('cardProfileImage');
        const cardProfilePlaceholder = document.getElementById('cardProfilePlaceholder');
        const cardProfileName = document.getElementById('cardProfileName');
        const cardUsernameTop = document.getElementById('cardUsernameTop');
        const cardBio = document.getElementById('cardBio');
        const socialLinksContainer = document.getElementById('socialLinksContainer');
        const followerCount = document.getElementById('followerCount');
        const postCount = document.getElementById('postCount');
        const followButton = document.getElementById('followButton');
        const editProfileCardPage = document.getElementById('editProfileCardPage');
        const backFromEditCardPage = document.getElementById('backFromEditCardPage');
        const editCardHeaderPreview = document.getElementById('editCardHeaderPreview');
        const editCardHeaderFile = document.getElementById('editCardHeaderFile');
        const editCardProfilePreview = document.getElementById('editCardProfilePreview');
        const editCardProfileFile = document.getElementById('editCardProfileFile');
        const editCardBio = document.getElementById('editCardBio');
        const editCardPronouns = document.getElementById('editCardPronouns');
        const editCardGender = document.getElementById('editCardGender');
        const editCardSexuality = document.getElementById('editCardSexuality');
        const editCardAge = document.getElementById('editCardAge');
        const editCardRelationship = document.getElementById('editCardRelationship');
        const editCardZodiac = document.getElementById('editCardZodiac');
        const editCardPersonality = document.getElementById('editCardPersonality');
        const editCardInstagram = document.getElementById('editCardInstagram');
        const editCardTiktok = document.getElementById('editCardTiktok');
        const saveProfileCard = document.getElementById('saveProfileCard');
        const cardUploadProgress = document.getElementById('cardUploadProgress');
        const additionalPhotosContainer = document.getElementById('additionalPhotosContainer');
        const shareProfileButton = document.getElementById('shareProfileButton');
        const userPostsFeed = document.getElementById('userPostsFeed');
        const userPostsEndMessage = document.getElementById('user-posts-end-message');
        const profileCardContent = document.getElementById('profileCardContent');
        const cardFeedTab = document.getElementById('cardFeedTab'); 
        const cardPostsTab = document.getElementById('cardPostsTab'); 
        const cardFeedContent = document.getElementById('cardFeedContent'); 
        const cardPostsContent = document.getElementById('cardPostsContent'); 
        const aboutButton = document.getElementById('aboutButton');
        const aboutDetails = document.getElementById('aboutDetails');
        const cardPronouns = document.getElementById('cardPronouns');
        const cardGender = document.getElementById('cardGender');
        const cardSexuality = document.getElementById('cardSexuality');
        const cardAge = document.getElementById('cardAge');
        const cardZodiac = document.getElementById('cardZodiac');
        const cardRelationshipStatus = document.getElementById('cardRelationshipStatus');
        const cardPersonality = document.getElementById('cardPersonality');
        const newPostNotification = document.getElementById('newPostNotification');
        const showNewPostsBtn = document.getElementById('showNewPostsBtn');
        const draftsModal = document.getElementById('draftsModal');
        const closeDraftsModal = document.getElementById('closeDraftsModal');
        const draftsList = document.getElementById('draftsList');
        const verificationButton = document.getElementById('verificationButton');
        const verificationPage = document.getElementById('verificationPage');
        const backFromVerificationPage = document.getElementById('backFromVerificationPage');
        const verificationFormContainer = document.getElementById('verificationFormContainer');
        const verificationStatusMessage = document.getElementById('verificationStatusMessage');
        const submitVerificationRequest = document.getElementById('submitVerificationRequest');
        const verificationCodeInput = document.getElementById('verificationCodeInput');
        const submitVerificationCode = document.getElementById('submitVerificationCode');
        const verificationCodeFeedback = document.getElementById('verificationCodeFeedback');
        const verificationImageFile = document.getElementById('verificationImageFile');
        const verificationImageName = document.getElementById('verificationImageName');
        const verificationImagePreviewContainer = document.getElementById('verificationImagePreviewContainer');
        const verificationImagePreview = document.getElementById('verificationImagePreview');
        const badgeNotification = document.getElementById('badgeNotification');
        const acceptBadgeButton = document.getElementById('acceptBadgeButton');
        const lightboxModal = document.getElementById('lightboxModal');
        const lightboxImage = document.getElementById('lightboxImage');
        const closeLightbox = document.getElementById('closeLightbox');
        const followersModal = document.getElementById('followersModal');
        const followersModalTitle = document.getElementById('followersModalTitle');
        const closeFollowersModal = document.getElementById('closeFollowersModal');
        const followersList = document.getElementById('followersList');
        const followersButton = document.getElementById('followersButton');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const discardPostModal = document.getElementById('discardPostModal');
        const confirmDiscard = document.getElementById('confirmDiscard');
        const saveDraftAndClose = document.getElementById('saveDraftAndClose');
        const cancelDiscard = document.getElementById('cancelDiscard');
        const profileActionModal = document.getElementById('profileActionModal');
        const viewProfilePhoto = document.getElementById('viewProfilePhoto');
        const viewProfileCard = document.getElementById('viewProfileCard');
        const cancelProfileAction = document.getElementById('cancelProfileAction');
        const adminModal = document.getElementById('adminModal');
        const backFromAdminPage = document.getElementById('backFromAdminPage');
        const pendingRequestsList = document.getElementById('pendingRequestsList');
        const verifiedUsersList = document.getElementById('verifiedUsersList');
        const refreshAdminData = document.getElementById('refreshAdminData');
        const ADMIN_UID = 'ArPXYRr8biPpbWOYoWCzlWOloMO2';

        let userId = null;
        let isRegisteredUser = false;
        let currentUserProfile = null;
        let currentTab = 'feed';
        let editingPostId = null;
        let editingDraftId = null;
        let editingComment = null;
        let isAuthModalInLoginMode = true;
        let currentProfileCardOwnerId = null;
        let confirmationCallback = null;
        let autoSaveInterval = null;
        let profileActionData = {};
        let currentCardTab = 'feed'; 
        let renderedPostIds = new Set();
        let newPostsQueue = [];
        const postsPerPage = 10;
        let lastVisibleDoc = null;
        let isLoadingPosts = false;
        let allPostsLoaded = false;
        let isSearching = false;
        let searchMode = 'posts';
        const commentListeners = new Map();
        const cardPageListeners = new Map(); 
        const userProfileCache = new Map();
        let pendingRequestsListener = null;
        let verifiedUsersListener = null;
        let notificationListener = null;
        const postListeners = new Map();
        
        const showSpinner = (button, text = '') => {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<div class="spinner mx-auto"></div> ${text}`;
        };

        const hideSpinner = (button) => {
            button.disabled = false;
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
            }
        };

        const uploadImageToImgBB = async (imageFile) => {
            const formData = new FormData();
            formData.append('image', imageFile);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) return result.data.url;
                else throw new Error(result.error.message);
            } catch (error) {
                console.error('Erro ao fazer upload da imagem:', error);
                return null;
            }
        };
        
        const getCachedUserProfile = async (uid) => {
            if (userProfileCache.has(uid)) {
                return userProfileCache.get(uid);
            }
            try {
                const profileRef = doc(db, `artifacts/${appId}/public/data/profiles/${uid}`);
                const profileSnap = await getDoc(profileRef);
                const profileData = profileSnap.exists() ? profileSnap.data() : {};
                userProfileCache.set(uid, profileData);
                return profileData;
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return {};
            }
        };

        const updateAllUiWithProfileChange = async (targetUserId) => {
            userProfileCache.delete(targetUserId);
            
            const collectionToLoad = currentTab === 'feed' ? 'posts' : 'anonymous_posts';
            if (currentTab !== 'trending_posts') {
                if(userId) loadPosts(collectionToLoad, false);
            } else {
                if(userId) loadTrendingPosts();
            }

            if(targetUserId === userId) {
                await fetchUserProfile(userId);
            }

            document.querySelectorAll(`[data-user-id="${targetUserId}"]`).forEach(async (el) => {
                const postId = el.dataset.postId;
                if (postId) {
                    const postRef = doc(db, `artifacts/${appId}/public/data/posts/${postId}`);
                    const postSnap = await getDoc(postRef);
                    if (postSnap.exists()) {
                        const newElement = await createPostElement({...postSnap.data(), id: postId, isAnonymous: false});
                        el.replaceWith(newElement);
                    }
                }
            });
        };

        const createPostElement = async (post, isForProfilePage = false) => {
            const postElement = document.createElement('div');
            postElement.classList.add('bg-black', 'p-4', 'rounded-xl', 'shadow-md', 'transition-all', 'duration-300', 'border', 'border-white', 'border-opacity-10');
            postElement.dataset.postId = post.id;
            postElement.dataset.isAnonymous = post.isAnonymous === true;
            postElement.dataset.userId = post.userId || 'anonimo';
            postElement.classList.add('post-element-class');

            const timestamp = post.timestamp?.seconds ? new Date(post.timestamp.seconds * 1000) : new Date();
            const timeString = timestamp.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
            
            const postUserId = post.userId || 'anonimo';
            const isMyPost = postUserId === userId;
            const isAnonymousPost = post.isAnonymous === true;
            
            const userPublicProfile = isAnonymousPost ? {} : await getCachedUserProfile(postUserId);
            const isVerified = userPublicProfile.isVerified === true;
            const verificationSealHtml = isVerified ? `<img src="${verificationSealUrl}" alt="Verificado" class="verification-seal">` : '';

            let postName = isAnonymousPost ? 'Anônimo' : (post.userName || `Usuário ${postUserId.substring(0, 8)}...`);
            let userAvatarUrl = isAnonymousPost ? '' : (post.userImage || `https://placehold.co/200x200/000000/FFFFFF?text=?`);
            
            let userAvatarHtml = isAnonymousPost ? `
                <div class="w-10 h-10 rounded-full bg-white bg-opacity-10 flex items-center justify-center overflow-hidden mr-3">
                    <i class="fas fa-user-secret text-xl text-white"></i>
                </div>` : `
                <div class="w-10 h-10 rounded-full overflow-hidden mr-3 relative cursor-pointer profile-avatar" data-user-id="${postUserId}" data-avatar-url="${userAvatarUrl}">
                    <img src="${userAvatarUrl}" alt="User Avatar" class="w-full h-full object-cover pointer-events-none" onerror="this.onerror=null;this.src='https://placehold.co/200x200/000000/FFFFFF?text=?'">
                    ${userPublicProfile.lastSeen && (Date.now() - userPublicProfile.lastSeen.toMillis() < 300000) ? '<div class="online-indicator"></div>' : ''}
                </div>`;
            
            const profileLinkHtml = isAnonymousPost ? 
            `<div class="flex items-center">
                ${userAvatarHtml}
                <div>
                    <p class="text-sm text-white font-bold flex items-center">${postName}</p>
                    <p class="text-xs text-white text-opacity-50">${timeString}</p>
                </div>
            </div>` :
            `<button class="flex items-center profile-link" data-user-id="${postUserId}" data-is-anonymous="${isAnonymousPost}" ${isForProfilePage ? 'disabled' : ''}>
                ${userAvatarHtml}
                <div>
                    <p class="text-sm text-white font-bold text-left flex items-center">${postName} ${verificationSealHtml}</p>
                    <p class="text-xs text-white text-opacity-50 text-left">${userPublicProfile.username ? '@' + userPublicProfile.username : timeString}</p>
                </div>
            </button>`;

            const likesCount = post.likesCount || 0;
            const commentsCount = post.commentsCount || 0;
            const postImageHtml = post.postImage ? `
                <div class="mt-4 rounded-lg w-full max-h-72 overflow-hidden flex justify-center items-center bg-black">
                    <img src="${post.postImage}" alt="Post Image" class="w-full h-full object-contain cursor-pointer post-image-clickable">
                </div>
            ` : '';
            const canManagePost = isMyPost && !isAnonymousPost && isRegisteredUser;
            const postLinkHtml = post.link ? `<a href="${post.link.startsWith('http') ? post.link : '//' + post.link}" target="_blank" rel="noopener noreferrer" class="mt-3 inline-block bg-white bg-opacity-10 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-opacity-20 transition-colors"><i class="fas fa-link mr-2"></i>Visitar Link</a>` : '';
            const commentInputAreaHtml = isRegisteredUser ? `
                <div class="comment-input-area flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-4">
                    <input type="text" placeholder="Adicionar um comentário..." class="w-full p-2 bg-white bg-opacity-10 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-white transition-colors comment-input">
                    <button class="send-comment-btn p-2 rounded-lg bg-white text-black hover:bg-white hover:bg-opacity-80 transition-colors active:scale-95">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>` : '';

            postElement.innerHTML = `
                <div class="flex items-center mb-2">
                    ${profileLinkHtml}
                    <div class="ml-auto flex space-x-2">
                        <button class="share-post-btn p-1 rounded-full text-white hover:text-white hover:bg-white hover:bg-opacity-10 transition-colors" data-id="${post.id}"><i class="fas fa-share-alt text-xs"></i></button>
                        ${canManagePost ? `
                            <button class="edit-btn p-1 rounded-full text-white hover:text-white hover:bg-white hover:bg-opacity-10 transition-colors" data-id="${post.id}"><i class="fas fa-edit text-xs"></i></button>
                            <button class="delete-btn p-1 rounded-full text-white hover:text-white hover:bg-white hover:bg-opacity-10 transition-colors" data-id="${post.id}"><i class="fas fa-trash text-xs"></i></button>
                        ` : ''}
                    </div>
                </div>
                <p class="text-white text-base leading-relaxed break-words">${post.content}</p>
                ${postImageHtml} ${postLinkHtml}
                <div class="flex items-center space-x-4 mt-4 text-white">
                    <button class="like-btn relative flex items-center space-x-2 hover:text-white transition-colors" data-id="${post.id}">
                        <i class="fas fa-heart text-lg ${post.likedBy && post.likedBy[userId] ? 'text-red-500' : 'text-white text-opacity-50'}"></i>
                        <span class="text-sm">${likesCount}</span>
                    </button>
                    <button class="comment-toggle-btn flex items-center space-x-2 hover:text-white transition-colors" data-id="${post.id}">
                        <i class="fas fa-comment text-lg"></i>
                        <span class="text-sm">${commentsCount}</span>
                    </button>
                </div>
                <div class="comments-container mt-4 hidden" data-id="${post.id}">
                    <div class="comment-list space-y-3"></div>
                    ${commentInputAreaHtml}
                </div>`;
            
            const collectionName = post.isAnonymous ? 'anonymous_posts' : 'posts';
            const postRef = doc(db, `artifacts/${appId}/public/data/${collectionName}/${post.id}`);
            const unsubscribe = onSnapshot(postRef, (docSnap) => {
                if (docSnap.exists()) {
                    const updatedPost = docSnap.data();
                    const likeCountSpan = postElement.querySelector('.like-btn span');
                    const commentCountSpan = postElement.querySelector('.comment-toggle-btn span');
                    const likeIcon = postElement.querySelector('.like-btn i');
                    
                    if (likeCountSpan) likeCountSpan.textContent = updatedPost.likesCount || 0;
                    if (commentCountSpan) commentCountSpan.textContent = updatedPost.commentsCount || 0;
                    if (likeIcon) {
                        const isLiked = updatedPost.likedBy && updatedPost.likedBy[userId];
                        likeIcon.classList.toggle('text-red-500', isLiked);
                        likeIcon.classList.toggle('text-white', !isLiked);
                        likeIcon.classList.toggle('text-opacity-50', !isLiked);
                    }
                }
            });
            postListeners.set(post.id, unsubscribe);

            return postElement;
        };
        
        const createCommentElement = async (comment, commentId, postId) => {
            const commentElement = document.createElement('div');
            commentElement.classList.add('flex', 'space-x-2', 'items-start', 'bg-white', 'bg-opacity-10', 'p-2', 'rounded-lg');
            const commentUserId = comment.userId || 'anonimo';
            const isMyComment = commentUserId === userId;
            const isAnonymousComment = comment.isAnonymous;
            
            const userPublicProfile = isAnonymousComment ? {} : await getCachedUserProfile(commentUserId);
            const isVerified = userPublicProfile.isVerified === true;
            const verificationSealHtml = isVerified ? `<img src="${verificationSealUrl}" alt="Verificado" class="verification-seal">` : '';

            let userAvatarUrl = isAnonymousComment ? '' : (comment.userImage || `https://placehold.co/200x200/000000/FFFFFF?text=?`);
            let userName = isAnonymousComment ? 'Anônimo' : (comment.userName || `Usuário ${commentUserId.substring(0, 8)}...`);
            let userAvatarHtml = isAnonymousComment ? `
                <div class="w-7 h-7 rounded-full bg-white bg-opacity-10 flex items-center justify-center"><i class="fas fa-user-secret text-xs text-white"></i></div>` : `
                <div class="w-7 h-7 rounded-full overflow-hidden cursor-pointer profile-avatar" data-user-id="${commentUserId}" data-avatar-url="${userAvatarUrl}"><img src="${userAvatarUrl}" alt="Commenter Avatar" class="w-full h-full object-cover pointer-events-none"></div>`;
            const canManageComment = isMyComment && !isAnonymousComment && isRegisteredUser;
            const profileLinkHtml = isAnonymousComment ? 
                `<div class="flex-grow">
                    <div class="flex items-center">${userAvatarHtml}<span class="text-xs font-bold text-white ml-2 flex items-center">${userName}</span></div>
                    <p class="text-xs text-white text-opacity-80 mt-1 break-words">${comment.content}</p>
                </div>` : 
                `<button class="flex-grow flex items-start profile-link" data-user-id="${commentUserId}" data-is-anonymous="${isAnonymousComment}">
                    ${userAvatarHtml}
                    <div class="ml-2">
                        <span class="text-xs font-bold text-white flex items-center">${userName} ${verificationSealHtml}</span>
                        <p class="text-xs text-white text-opacity-80 mt-1 break-words text-left">${comment.content}</p>
                    </div>
                </button>`;
            commentElement.innerHTML = `
                ${profileLinkHtml}
                ${canManageComment ? `
                    <div class="ml-auto flex space-x-2">
                        <button class="edit-comment-btn text-white hover:text-white hover:bg-white hover:bg-opacity-10 transition-colors" data-post-id="${postId}" data-comment-id="${commentId}"><i class="fas fa-edit text-xs"></i></button>
                        <button class="delete-comment-btn text-white hover:text-white hover:bg-white hover:bg-opacity-10 transition-colors" data-post-id="${postId}" data-comment-id="${commentId}"><i class="fas fa-trash text-xs"></i></button>
                    </div>` : (isRegisteredUser ? `
                    <button class="reply-comment-btn ml-auto text-white hover:text-white hover:bg-white hover:bg-opacity-10 transition-colors text-xs" data-user-name="${userName}">Responder</button>` : '')}`;
            return commentElement;
        };
        
        const fetchUserProfile = async (uid) => {
            if (!uid) return;
            try {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${uid}/profile/data`);
                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/profiles/${uid}`);
                
                const [docSnap, publicDocSnap] = await Promise.all([getDoc(userProfileRef), getDoc(publicProfileRef)]);

                let userPrivateData;
                if (docSnap.exists()) {
                    userPrivateData = docSnap.data();
                } else {
                    const defaultName = auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'Ravezeiro';
                    userPrivateData = { name: defaultName, image: '' };
                    await setDoc(userProfileRef, userPrivateData);
                }

                const userPublicData = publicDocSnap.exists() ? publicDocSnap.data() : {};
                currentUserProfile = { ...userPrivateData, ...userPublicData };
                userProfileCache.set(uid, { ...userPrivateData, ...userPublicData });

                updateProfileUI(currentUserProfile);
            } catch (error) {
                console.error("Erro ao carregar perfil do usuário:", error);
            }
        };
        
        const updateProfileUI = (profile) => {
            if (!profile) return;
            const verificationSealHtml = profile.isVerified ? `<img src="${verificationSealUrl}" alt="Verificado" class="verification-seal">` : '';
            profileNameDisplay.innerHTML = `${profile.name} ${verificationSealHtml}`;
            if (profile.image) {
                profileImage.src = profile.image;
                profilePreviewImage.src = profile.image;
                profileImage.classList.remove('hidden');
                profilePlaceholder.classList.add('hidden');
            } else {
                profileImage.classList.add('hidden');
                profilePlaceholder.classList.remove('hidden');
                profilePreviewImage.src = 'https://placehold.co/200x200/000000/FFFFFF?text=?';
            }
        };
        
        const resetProfileUI = () => {
             profileNameDisplay.innerHTML = 'Visitante';
             profileImage.src = '';
             profileImage.classList.add('hidden');
             profilePlaceholder.classList.remove('hidden');
             userIdDisplay.textContent = 'N/A';
             currentUserProfile = null;
        };

        const showSkeletonLoaders = (container = feed) => {
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-post';
                skeleton.innerHTML = `
                    <div class="skeleton-header">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line long"></div>
                            <div class="skeleton-line short"></div>
                        </div>
                    </div>
                    <div class="skeleton-content">
                        <div class="skeleton-line" style="width: 90%;"></div>
                        <div class="skeleton-line" style="width: 80%;"></div>
                    </div>
                `;
                container.appendChild(skeleton);
            }
        };

        const cleanupPostListeners = () => {
            for (const unsubscribe of postListeners.values()) {
                unsubscribe();
            }
            postListeners.clear();
        };

        const loadPosts = async (collectionName, append = false, searchQuery = '') => {
            if (isLoadingPosts || (allPostsLoaded && append)) return;
            isLoadingPosts = true;
            feedEndMessage.classList.add('hidden');
            
            if (!append) {
                cleanupPostListeners();
                showSkeletonLoaders();
                renderedPostIds.clear();
                allPostsLoaded = false;
                lastVisibleDoc = null;
            }
            
            if(!userId) {
                feed.innerHTML = '';
                isLoadingPosts = false;
                return;
            }
            
            try {
                let finalDocs = [];
                if (searchQuery) {
                    isSearching = true;
                    allPostsLoaded = true;
                    const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                    const normalizedSearch = searchQuery.toLowerCase();
                    
                    const contentQuery = query(postsCollectionRef, where('content', '>=', normalizedSearch), where('content', '<=', normalizedSearch + '\uf8ff'));
                    const nameQuery = query(postsCollectionRef, where('userName', '>=', searchQuery), where('userName', '<=', searchQuery + '\uf8ff'));
                    const uidQuery = query(postsCollectionRef, where('userId', '==', searchQuery));

                    const [contentSnap, nameSnap, uidSnap] = await Promise.all([getDocs(contentQuery), getDocs(nameQuery), getDocs(uidQuery)]);
                    
                    const uniquePosts = new Map();
                    contentSnap.forEach(doc => uniquePosts.set(doc.id, { id: doc.id, ...doc.data() }));
                    nameSnap.forEach(doc => uniquePosts.set(doc.id, { id: doc.id, ...doc.data() }));
                    uidSnap.forEach(doc => uniquePosts.set(doc.id, { id: doc.id, ...doc.data() }));
                    
                    finalDocs = Array.from(uniquePosts.values()).sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);

                } else {
                    isSearching = false;
                    const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                    const q = lastVisibleDoc 
                        ? query(postsCollectionRef, orderBy('timestamp', 'desc'), startAfter(lastVisibleDoc), limit(postsPerPage))
                        : query(postsCollectionRef, orderBy('timestamp', 'desc'), limit(postsPerPage));
                    
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.docs.length < postsPerPage) {
                        allPostsLoaded = true;
                        feedEndMessage.classList.remove('hidden');
                    }
                    lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    finalDocs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                if (!append) feed.innerHTML = '';

                if (finalDocs.length === 0 && !append) {
                    feed.innerHTML = `<div class="text-center text-white text-opacity-50 py-8"><p>Nenhuma postagem encontrada.</p></div>`;
                } else {
                    for (const postData of finalDocs) {
                        if (renderedPostIds.has(postData.id)) continue;
                        const isAnonymous = collectionName === 'anonymous_posts';
                        const postElement = await createPostElement({ ...postData, isAnonymous });
                        feed.appendChild(postElement);
                        renderedPostIds.add(postData.id);
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar o feed:", error);
                feed.innerHTML = `<div class="text-center text-red-400 py-8"><p>Erro ao carregar o feed.</p></div>`;
            } finally {
                isLoadingPosts = false;
            }
        };

        const loadTrendingPosts = async () => {
            if (isLoadingPosts) return;
            isLoadingPosts = true;
            cleanupPostListeners();
            showSkeletonLoaders();
            renderedPostIds.clear();
            allPostsLoaded = true;
            if(!userId) {
                feed.innerHTML = '';
                isLoadingPosts = false;
                return;
            }
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
            const anonymousPostsCollectionRef = collection(db, `artifacts/${appId}/public/data/anonymous_posts`);
            
            try {
                const q = query(postsCollectionRef, where('likesCount', '>', 10), orderBy('likesCount', 'desc'));
                const qAnon = query(anonymousPostsCollectionRef, where('likesCount', '>', 10), orderBy('likesCount', 'desc'));
                const [querySnapshot, querySnapshotAnon] = await Promise.all([getDocs(q), getDocs(qAnon)]);
                
                let allPosts = [];
                querySnapshot.forEach(doc => allPosts.push({ id: doc.id, ...doc.data(), isAnonymous: false }));
                querySnapshotAnon.forEach(doc => allPosts.push({ id: doc.id, ...doc.data(), isAnonymous: true }));
                allPosts.sort((a, b) => ((b.likesCount || 0) + (b.commentsCount || 0) * 2) - ((a.likesCount || 0) + (a.commentsCount || 0) * 2));
                
                feed.innerHTML = '';
                if (allPosts.length === 0) {
                    feed.innerHTML = `<div class="text-center text-white text-opacity-50 py-8"><p>Nenhuma postagem em alta encontrada.</p></div>`;
                } else {
                    for (const post of allPosts) {
                        if (renderedPostIds.has(post.id)) continue;
                        const postElement = await createPostElement(post);
                        feed.appendChild(postElement);
                        renderedPostIds.add(post.id);
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar posts em alta:", error);
                feed.innerHTML = `<div class="text-center text-red-400 py-8"><p>Erro ao carregar posts em alta.</p></div>`;
            } finally {
                isLoadingPosts = false;
            }
        };

        const switchTab = (tabName) => {
            currentTab = tabName;
            [feedTab, anonymousTab, trendingTab].forEach(tab => {
                tab.classList.remove('bg-white', 'text-black');
                tab.classList.add('text-white', 'hover:bg-white', 'hover:bg-opacity-10');
            });
            
            let activeTabButton;
            if (tabName === 'feed') {
                activeTabButton = feedTab;
                postModalTitle.textContent = 'Nova Postagem';
                if(userId) { loadPosts('posts', false); }
            } else if (tabName === 'anonymous') {
                activeTabButton = anonymousTab;
                postModalTitle.textContent = 'Postagem Anônima';
                if(userId) { loadPosts('anonymous_posts', false); }
            } else {
                activeTabButton = trendingTab;
                postModalTitle.textContent = 'Nova Postagem';
                if(userId) loadTrendingPosts();
            }
            
            activeTabButton.classList.add('bg-white', 'text-black');
            activeTabButton.classList.remove('text-white', 'hover:bg-white', 'hover:bg-opacity-10');
            feed.scrollTo(0, 0);
        };
        
        const updateUIForAuthState = (user) => {
            isRegisteredUser = user && !user.isAnonymous;
            postFab.style.display = isRegisteredUser ? 'flex' : 'none';
            notificationButton.classList.toggle('hidden', !isRegisteredUser);

            if (isRegisteredUser) {
                loggedInButtons.classList.remove('hidden');
                loginSignupButton.classList.add('hidden');
                fetchUserProfile(user.uid);
            } else {
                loggedInButtons.classList.add('hidden');
                loginSignupButton.classList.remove('hidden');
                resetProfileUI(); 
            }
        };
        
        const startApp = async () => {
             try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Erro ao inicializar Firebase. Verifique a configuração.", e);
                document.getElementById('app-container').classList.add('hidden');
                document.querySelector('header').classList.add('hidden');
                document.querySelector('nav').classList.add('hidden');
                document.getElementById('initError').classList.remove('hidden');
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    updateUIForAuthState(user);
                    if (isRegisteredUser) {
                        const notificationsRef = collection(db, `artifacts/${appId}/users/${userId}/notifications`);
                        const q = query(notificationsRef, where('type', '==', 'verification_approved'));
                        if (notificationListener) notificationListener();
                        notificationListener = onSnapshot(q, (snapshot) => {
                            if (!snapshot.empty) {
                                notificationBadge.classList.remove('hidden');
                                notificationModal.dataset.notificationId = snapshot.docs[0].id;
                                notificationList.innerHTML = '';
                                snapshot.docs.forEach(doc => {
                                    const notif = doc.data();
                                    const notifEl = document.createElement('div');
                                    notifEl.className = 'p-3 bg-white bg-opacity-10 rounded-lg flex justify-between items-center';
                                    notifEl.innerHTML = `<p class="text-sm">${notif.message}</p><button class="bg-black text-white px-3 py-1 rounded-full font-bold text-xs hover:bg-gray-800 transition-colors accept-notif-btn" data-id="${doc.id}">Obter Selo</button>`;
                                    notificationList.appendChild(notifEl);
                                });
                            } else {
                                notificationBadge.classList.add('hidden');
                                if (notificationModal.classList.contains('hidden') === false) {
                                    notificationList.innerHTML = '<p class="text-center text-white text-opacity-50">Nenhuma notificação por enquanto.</p>';
                                }
                            }
                        });
                    } else if (notificationListener) {
                        notificationListener();
                        notificationListener = null;
                        notificationBadge.classList.add('hidden');
                    }
                } else {
                    try { await signInAnonymously(auth); } catch (error) { console.error("Erro ao fazer login anônimo:", error); }
                }
                switchTab('feed');
                handleDirectLinks();
            });
            feed.addEventListener('scroll', () => {
                if (currentTab === 'trending_posts') return;
                const { scrollTop, scrollHeight, clientHeight } = feed;
                if (scrollTop + clientHeight >= scrollHeight - 5 && !isLoadingPosts && !allPostsLoaded && !isSearching) {
                    const collectionToLoad = currentTab === 'feed' ? 'posts' : 'anonymous_posts';
                    if(userId) loadPosts(collectionToLoad, true);
                }
                backToTopBtn.style.display = feed.scrollTop > 300 ? 'flex' : 'none';
            });
        };

        feedTab.addEventListener('click', () => switchTab('feed'));
        anonymousTab.addEventListener('click', () => switchTab('anonymous'));
        trendingTab.addEventListener('click', () => switchTab('trending_posts'));

        mainHeader.addEventListener('click', () => {
            feed.scrollTo({ top: 0, behavior: 'smooth' });
            const collectionToLoad = currentTab === 'feed' ? 'posts' : 'anonymous_posts';
            if(currentTab !== 'trending_posts') {
                if(userId) loadPosts(collectionToLoad, false);
            } else {
                if(userId) loadTrendingPosts();
            }
        });
        
        searchButton.addEventListener('click', () => searchModal.classList.remove('hidden'));
        closeSearchModal.addEventListener('click', () => searchModal.classList.add('hidden'));
        
        document.addEventListener('click', (e) => {
            if (!searchModal.classList.contains('hidden') && !searchModal.contains(e.target) && e.target !== searchButton && !searchButton.contains(e.target)) {
                searchModal.classList.add('hidden');
            }
        });

        const performUserSearch = async (searchTerm) => {
            if (!searchTerm) {
                searchResults.innerHTML = '';
                return;
            }
            searchResults.innerHTML = '<div class="spinner mx-auto my-4"></div>';
            try {
                const profilesRef = collection(db, `artifacts/${appId}/public/data/profiles`);
                const nameQuery = query(profilesRef, where('name', '>=', searchTerm), where('name', '<=', searchTerm + '\uf8ff'));
                const usernameQuery = query(profilesRef, where('username', '>=', searchTerm.toLowerCase()), where('username', '<=', searchTerm.toLowerCase() + '\uf8ff'));

                const [nameSnap, usernameSnap] = await Promise.all([getDocs(nameQuery), getDocs(usernameQuery)]);
                
                const users = new Map();
                nameSnap.forEach(doc => users.set(doc.id, { id: doc.id, ...doc.data() }));
                usernameSnap.forEach(doc => users.set(doc.id, { id: doc.id, ...doc.data() }));

                searchResults.innerHTML = '';
                if (users.size === 0) {
                    searchResults.innerHTML = '<p class="text-center text-white text-opacity-50 p-4">Nenhum usuário encontrado.</p>';
                } else {
                    for (const user of users.values()) {
                        const userEl = document.createElement('div');
                        userEl.className = 'flex items-center p-2 rounded-lg justify-between';
                        
                        let followButtonHtml = '';
                        if(isRegisteredUser && user.id !== userId) {
                            const followingRef = doc(db, `artifacts/${appId}/users/${userId}/following/${user.id}`);
                            const followingSnap = await getDoc(followingRef);
                            if(followingSnap.exists()){
                                followButtonHtml = `<button class="follow-search-btn text-xs bg-white bg-opacity-20 text-white font-semibold py-1 px-3 rounded-lg" data-user-id="${user.id}">Seguindo</button>`;
                            } else {
                                followButtonHtml = `<button class="follow-search-btn text-xs bg-white text-black font-semibold py-1 px-3 rounded-lg" data-user-id="${user.id}">Seguir</button>`;
                            }
                        }

                        userEl.innerHTML = `
                            <div class="flex items-center cursor-pointer profile-link" data-user-id="${user.id}">
                                <img src="${user.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?'}" class="w-10 h-10 rounded-full object-cover mr-3">
                                <div>
                                    <p class="font-semibold text-sm">${user.name || 'Usuário'}</p>
                                    <p class="text-xs text-white text-opacity-50">${user.username ? '@' + user.username : ''}</p>
                                </div>
                            </div>
                            ${followButtonHtml}
                        `;
                        searchResults.appendChild(userEl);
                    }
                }
            } catch (error) {
                console.error("Error searching users:", error);
                searchResults.innerHTML = '<p class="text-center text-red-400 p-4">Erro ao buscar usuários.</p>';
            }
        };

        let searchDebounce;
        searchBar.addEventListener('keyup', (e) => {
            clearTimeout(searchDebounce);
            const searchTerm = e.target.value.trim();
            if (searchMode === 'posts') {
                 if (e.key === 'Enter') {
                    const collectionToSearch = currentTab === 'anonymous' ? 'anonymous_posts' : 'posts';
                    if(userId) loadPosts(collectionToSearch, false, searchTerm);
                    searchModal.classList.add('hidden'); 
                } else if (searchTerm === '') {
                    const collectionToSearch = currentTab === 'anonymous' ? 'anonymous_posts' : 'posts';
                    if(userId) loadPosts(collectionToSearch, false, '');
                }
            } else {
                searchDebounce = setTimeout(() => {
                    performUserSearch(searchTerm);
                }, 500);
            }
        });

        searchPostsTab.addEventListener('click', () => {
            searchMode = 'posts';
            searchPostsTab.classList.add('border-white', 'text-white');
            searchPostsTab.classList.remove('border-transparent', 'text-gray-400');
            searchUsersTab.classList.add('border-transparent', 'text-gray-400');
            searchUsersTab.classList.remove('border-white', 'text-white');
            searchBar.placeholder = 'Pesquisar por postagens...';
            searchResults.innerHTML = '';
        });

        searchUsersTab.addEventListener('click', () => {
            searchMode = 'users';
            searchUsersTab.classList.add('border-white', 'text-white');
            searchUsersTab.classList.remove('border-transparent', 'text-gray-400');
            searchPostsTab.classList.add('border-transparent', 'text-gray-400');
            searchPostsTab.classList.remove('border-white', 'text-white');
            searchBar.placeholder = 'Pesquisar por @username ou nome...';
            searchResults.innerHTML = '';
        });

        searchResults.addEventListener('click', async (e) => {
            const profileLink = e.target.closest('.profile-link');
            const followBtn = e.target.closest('.follow-search-btn');

            if (profileLink) {
                const profileOwnerId = profileLink.dataset.userId;
                if (profileOwnerId) openProfileCard(profileOwnerId);
                searchModal.classList.add('hidden');
            } else if (followBtn) {
                const userToFollowId = followBtn.dataset.userId;
                followBtn.disabled = true;

                const followingRef = doc(db, `artifacts/${appId}/users/${userId}/following/${userToFollowId}`);
                const followerRef = doc(db, `artifacts/${appId}/users/${userToFollowId}/followers/${userId}`);

                try {
                    const followingSnap = await getDoc(followingRef);
                    if (followingSnap.exists()) {
                        await deleteDoc(followingRef);
                        await deleteDoc(followerRef);
                        followBtn.textContent = 'Seguir';
                        followBtn.classList.remove('bg-white', 'bg-opacity-20', 'text-white');
                        followBtn.classList.add('bg-white', 'text-black');
                    } else {
                        await setDoc(followingRef, { timestamp: serverTimestamp() });
                        await setDoc(followerRef, { timestamp: serverTimestamp() });
                        followBtn.textContent = 'Seguindo';
                        followBtn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
                        followBtn.classList.remove('bg-white', 'text-black');
                    }
                } catch (error) {
                    console.error("Error following user from search:", error);
                } finally {
                    followBtn.disabled = false;
                }
            }
        });

        const resetPostModal = () => {
            postModal.classList.add('hidden');
            postContent.value = ''; 
            postImageFile.value = ''; 
            postFileName.textContent = 'Selecionar Imagem (Opcional)';
            postUploadProgress.classList.add('hidden');
            postImagePreviewContainer.classList.add('hidden');
            postImagePreview.src = '';
            editingDraftId = null;
            if (autoSaveInterval) clearInterval(autoSaveInterval);
        };

        postFab.addEventListener('click', () => {
            editingDraftId = null;
            postModal.classList.remove('hidden');
            autoSaveInterval = setInterval(() => handlePostSubmission(true, true), 10000);
        });
        
        closePostModal.addEventListener('click', () => {
            if (postContent.value.trim() !== '' || postImageFile.files.length > 0) {
                discardPostModal.classList.remove('hidden');
            } else {
                resetPostModal();
            }
        });

        postImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            postFileWarning.classList.add('hidden');
            const maxFileSizeMB = 5;
            if (file && file.size > maxFileSizeMB * 1024 * 1024) {
                 postFileWarning.textContent = `A imagem/GIF não pode ter mais de ${maxFileSizeMB}MB.`;
                 postFileWarning.classList.remove('hidden');
                 postFileName.textContent = 'Selecionar Mídia (Imagem ou GIF)';
                 postImagePreviewContainer.classList.add('hidden');
                 postImagePreview.src = '';
                 e.target.value = '';
                 return;
            }
            postFileName.textContent = file ? file.name : 'Selecionar Imagem (Opcional)';
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { postImagePreview.src = e.target.result; postImagePreviewContainer.classList.remove('hidden'); };
                reader.readAsDataURL(file);
            } else {
                postImagePreviewContainer.classList.add('hidden'); postImagePreview.src = '';
            }
        });

        const handlePostSubmission = async (isDraft = false, isAutoSave = false) => {
            if (!isRegisteredUser) return;
            const content = postContent.value.trim();
            const imageFile = postImageFile.files[0];
            if (!content && !imageFile) return;

            if (!isAutoSave) {
                const buttonToSpin = isDraft ? saveDraft : submitPost;
                showSpinner(buttonToSpin);
            }

            try {
                if (imageFile && !isAutoSave) {
                    postUploadProgress.textContent = "Carregando imagem...";
                    postUploadProgress.classList.remove('hidden');
                }
                let postImageUrl = imageFile ? await uploadImageToImgBB(imageFile) : (editingDraftId ? (await getDoc(doc(db, `artifacts/${appId}/users/${userId}/drafts/${editingDraftId}`))).data().postImage : null);
                
                if (isDraft) {
                    const draftData = { content, postImage: postImageUrl, timestamp: serverTimestamp() };
                    const draftRef = editingDraftId 
                        ? doc(db, `artifacts/${appId}/users/${userId}/drafts/${editingDraftId}`)
                        : doc(collection(db, `artifacts/${appId}/users/${userId}/drafts`));
                    await setDoc(draftRef, draftData, { merge: true });
                    if (!editingDraftId) editingDraftId = draftRef.id;
                } else {
                    const isAnonymousPost = currentTab === 'anonymous';
                    const collectionName = isAnonymousPost ? 'anonymous_posts' : 'posts';
                    const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                    const postData = {
                        content, userId, timestamp: serverTimestamp(), postImage: postImageUrl,
                        likesCount: 0, commentsCount: 0, isAnonymous: isAnonymousPost,
                        userName: isAnonymousPost ? 'Anônimo' : currentUserProfile.name,
                        userImage: isAnonymousPost ? '' : currentUserProfile.image
                    };
                    const newPostRef = await addDoc(postsCollectionRef, postData);
                    const newPostElement = await createPostElement({id: newPostRef.id, ...postData, timestamp: new Date()});
                    feed.insertBefore(newPostElement, feed.firstChild);
                    renderedPostIds.add(newPostRef.id);
                    if (editingDraftId) {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/drafts/${editingDraftId}`));
                    }
                }
                if (!isAutoSave) resetPostModal();
            } catch (error) {
                console.error("Erro ao salvar:", error);
            } finally {
                if (!isAutoSave) {
                    hideSpinner(submitPost);
                    hideSpinner(saveDraft);
                    postUploadProgress.classList.add('hidden');
                }
            }
        };

        submitPost.addEventListener('click', () => handlePostSubmission(false));
        saveDraft.addEventListener('click', () => handlePostSubmission(true));
        
        confirmDiscard.addEventListener('click', () => {
            discardPostModal.classList.add('hidden');
            resetPostModal();
        });
        saveDraftAndClose.addEventListener('click', async () => {
            await handlePostSubmission(true);
            discardPostModal.classList.add('hidden');
        });
        cancelDiscard.addEventListener('click', () => {
            discardPostModal.classList.add('hidden');
        });


        profileButton.addEventListener('click', () => { sideMenu.classList.remove('-translate-x-full'); sideMenuOverlay.classList.remove('hidden'); });
        const closeMenu = () => { sideMenu.classList.add('-translate-x-full'); sideMenuOverlay.classList.add('hidden'); };
        closeSideMenu.addEventListener('click', closeMenu);
        sideMenuOverlay.addEventListener('click', closeMenu);

        editProfileButton.addEventListener('click', () => {
            profileNameInput.value = currentUserProfile.name || '';
            profileUsernameInput.value = currentUserProfile.username || '';
            profileImageFile.value = '';
            profileFileName.textContent = 'Selecionar Imagem';
            profilePreviewImage.src = currentUserProfile.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?';
            profileEditModal.classList.remove('hidden');
            closeMenu();
        });
        
        rulesButton.addEventListener('click', () => { rulesModal.classList.remove('hidden'); closeMenu(); });
        
        closeProfileEditModal.addEventListener('click', () => profileEditModal.classList.add('hidden'));
        closeRulesModal.addEventListener('click', () => rulesModal.classList.add('hidden'));
        rulesModal.addEventListener('click', (e) => { if (e.target.id === 'rulesModal') rulesModal.classList.add('hidden'); });

        profileImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            profileFileName.textContent = file ? file.name : 'Selecionar Imagem';
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => profilePreviewImage.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });
        
        let usernameCheckTimeout;
        profileUsernameInput.addEventListener('input', (e) => {
            clearTimeout(usernameCheckTimeout);
            const username = e.target.value.toLowerCase().trim();
            usernameStatus.innerHTML = '';
            if (username.length < 3 || !/^[a-z0-9_.]+$/.test(username)) {
                if (username.length > 0) {
                    usernameStatus.innerHTML = `<i class="fas fa-times text-red-500"></i>`;
                }
                return;
            }
            usernameStatus.innerHTML = `<div class="spinner"></div>`;
            usernameCheckTimeout = setTimeout(async () => {
                const profilesRef = collection(db, `artifacts/${appId}/public/data/profiles`);
                const q = query(profilesRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                const isTaken = !snapshot.empty && snapshot.docs[0].id !== userId;
                if (isTaken) {
                    usernameStatus.innerHTML = `<i class="fas fa-times text-red-500"></i>`;
                } else {
                    usernameStatus.innerHTML = `<i class="fas fa-check text-green-500"></i>`;
                }
            }, 500);
        });

        saveProfile.addEventListener('click', async () => {
            if (!userId) return;
            const name = profileNameInput.value.trim();
            const username = profileUsernameInput.value.toLowerCase().trim();
            const imageFile = profileImageFile.files[0];
            
            showSpinner(saveProfile);
            try {
                profileUploadProgress.classList.remove('hidden');
                profileUploadProgress.textContent = "Salvando perfil...";

                if (username) {
                    const profilesRef = collection(db, `artifacts/${appId}/public/data/profiles`);
                    const q = query(profilesRef, where('username', '==', username));
                    const snapshot = await getDocs(q);
                    const isTaken = !snapshot.empty && snapshot.docs[0].id !== userId;
                    if (isTaken) {
                        throw new Error("Este @username já está em uso.");
                    }
                }

                let newImageUrl = currentUserProfile.image;
                if (imageFile) {
                    profileUploadProgress.textContent = "Carregando imagem...";
                    newImageUrl = await uploadImageToImgBB(imageFile);
                    if (!newImageUrl) throw new Error("Erro ao carregar a imagem.");
                }
                
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);

                const newPrivateProfile = { name: name || currentUserProfile.name, image: newImageUrl };
                const newPublicProfile = { 
                    username: username || currentUserProfile.username || null,
                    name: name || currentUserProfile.name,
                    image: newImageUrl
                };

                await setDoc(userProfileRef, newPrivateProfile, { merge: true });
                await setDoc(publicProfileRef, newPublicProfile, { merge: true });

                currentUserProfile = { ...currentUserProfile, ...newPrivateProfile, ...newPublicProfile };
                updateProfileUI(currentUserProfile);
                
                const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
                const userPostsQuery = query(postsRef, where('userId', '==', userId));
                const userPostsSnap = await getDocs(userPostsQuery);

                const batch = writeBatch(db);
                userPostsSnap.forEach(postDoc => {
                    batch.update(postDoc.ref, { 
                        userName: currentUserProfile.name,
                        userImage: currentUserProfile.image
                    });
                });
                await batch.commit();

                profileUploadProgress.textContent = "Perfil salvo com sucesso!";
                
                profileImageFile.value = '';
                profileFileName.textContent = 'Selecionar Imagem';
                setTimeout(() => profileEditModal.classList.add('hidden'), 1000);
            } catch (error) {
                console.error("Erro ao salvar perfil:", error);
                profileUploadProgress.textContent = error.message || "Erro ao salvar. Tente novamente.";
            } finally {
                hideSpinner(saveProfile);
                setTimeout(() => profileUploadProgress.classList.add('hidden'), 2000);
            }
        });
        
        const showAuthError = (message) => { authErrorMessage.textContent = message; authErrorMessage.classList.remove('hidden'); };
        loginSignupButton.addEventListener('click', () => { authModal.classList.remove('hidden'); closeMenu(); });
        closeAuthModal.addEventListener('click', () => authModal.classList.add('hidden'));
        authToggleButton.addEventListener('click', () => {
            isAuthModalInLoginMode = !isAuthModalInLoginMode;
            authModalTitle.textContent = isAuthModalInLoginMode ? 'Entrar' : 'Criar Conta';
            authSubmitButton.textContent = isAuthModalInLoginMode ? 'Entrar' : 'Criar Conta';
            authToggleText.textContent = isAuthModalInLoginMode ? 'Não tem uma conta?' : 'Já tem uma conta?';
            authToggleButton.textContent = isAuthModalInLoginMode ? 'Crie uma aqui.' : 'Entre aqui.';
            authErrorMessage.classList.add('hidden');
        });
        togglePassword.addEventListener('click', () => {
            const isPassword = authPassword.type === 'password';
            authPassword.type = isPassword ? 'text' : 'password';
            togglePassword.querySelector('i').classList.toggle('fa-eye');
            togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
        });
        authSubmitButton.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            showSpinner(authSubmitButton);
            authErrorMessage.classList.add('hidden');
            try {
                if (isAuthModalInLoginMode) await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
                authModal.classList.add('hidden');
            } catch (error) {
                let m = "Ocorreu um erro. Tente novamente.";
                switch (error.code) {
                    case 'auth/invalid-email': m = "Email inválido."; break;
                    case 'auth/user-not-found': m = "Usuário não encontrado."; break;
                    case 'auth/wrong-password': m = "Senha incorreta."; break;
                    case 'auth/email-already-in-use': m = "Este email já está em uso."; break;
                    case 'auth/weak-password': m = "A senha deve ter pelo menos 6 caracteres."; break;
                }
                showAuthError(m);
            } finally {
                hideSpinner(authSubmitButton);
            }
        });
        logoutButton.addEventListener('click', async () => { 
            confirmationModalText.textContent = "Tem certeza que deseja sair?";
            deleteConfirmationModal.classList.remove('hidden');
            confirmationCallback = async () => {
                await signOut(auth); 
                closeMenu();
                deleteConfirmationModal.classList.add('hidden');
            };
        });
        
        confirmDeleteBtn.addEventListener('click', () => {
            if (confirmationCallback) {
                confirmationCallback();
                confirmationCallback = null;
            }
        });
        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmationModal.classList.add('hidden');
            confirmationCallback = null;
        });

        document.body.addEventListener('click', async (e) => {
            const target = e.target;
            if (!target) return;

            if(target.classList.contains('post-image-clickable')) {
                lightboxImage.src = target.src;
                lightboxModal.style.display = 'flex';
                return;
            }
            
            if(target.classList.contains('profile-avatar')) {
                profileActionData.userId = target.dataset.userId;
                profileActionData.avatarUrl = target.dataset.avatarUrl;
                profileActionModal.classList.remove('hidden');
                return;
            }

            const button = target.closest('button');
            if (!button) return;

            const postElement = button.closest('[data-post-id]');
            if (!postElement) return;

            const postId = postElement.dataset.postId;
            const postOwnerId = postElement.dataset.userId;
            const isMyPost = postOwnerId === userId;
            const isAnonymousPost = postElement.dataset.isAnonymous === 'true';
            const collectionName = isAnonymousPost ? 'anonymous_posts' : 'posts';
            const postRef = doc(db, `artifacts/${appId}/public/data/${collectionName}/${postId}`);

            if (button.classList.contains('like-btn')) {
                if (!userId) return;
                
                const likeIcon = button.querySelector('i');
                const isCurrentlyLiked = likeIcon.classList.contains('text-red-500');
                if (!isCurrentlyLiked) {
                    triggerLikeAnimation(button);
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        const postDoc = await transaction.get(postRef);
                        if (!postDoc.exists()) throw "Document does not exist!";
                        const postData = postDoc.data();
                        const likedBy = postData.likedBy || {};
                        let newLikesCount = postData.likesCount || 0;
                        if (likedBy[userId]) { delete likedBy[userId]; newLikesCount--; } else { likedBy[userId] = true; newLikesCount++; }
                        transaction.update(postRef, { likesCount: newLikesCount < 0 ? 0 : newLikesCount, likedBy: likedBy });
                    });
                } catch(error) {
                    console.error("Erro ao curtir a postagem:", error);
                }
            }
            
            if (button.classList.contains('comment-toggle-btn')) {
                const commentsContainer = postElement.querySelector('.comments-container');
                commentsContainer.classList.toggle('hidden');
                if (!commentsContainer.classList.contains('hidden') && !commentListeners.has(postId)) {
                    const commentList = commentsContainer.querySelector('.comment-list');
                    commentList.innerHTML = '<div class="text-center text-white text-opacity-50">Carregando...</div>';
                    const commentsRef = collection(db, `artifacts/${appId}/public/data/${collectionName}/${postId}/comments`);
                    const q = query(commentsRef, orderBy('timestamp', 'asc'));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        commentList.innerHTML = '';
                        snapshot.forEach(async doc => { 
                            const commentElement = await createCommentElement(doc.data(), doc.id, postId);
                            commentList.appendChild(commentElement); 
                        });
                    }, (error) => console.error("Erro ao carregar comentários:", error));
                    commentListeners.set(postId, unsubscribe);
                } else if (commentsContainer.classList.contains('hidden') && commentListeners.has(postId)) {
                    commentListeners.get(postId)();
                    commentListeners.delete(postId);
                }
            }
            
            if (button.classList.contains('send-comment-btn')) {
                if (!isRegisteredUser) return;
                const commentInput = postElement.querySelector('.comment-input');
                const commentContent = commentInput.value.trim();
                if (commentContent) {
                    const commentsRef = collection(db, `artifacts/${appId}/public/data/${collectionName}/${postId}/comments`);
                    const isAnonComment = auth.currentUser.isAnonymous || isAnonymousPost;
                    const commentData = {
                        content: commentContent, userId, timestamp: serverTimestamp(), isAnonymous: isAnonComment,
                        userName: isAnonComment ? 'Anônimo' : currentUserProfile.name,
                        userImage: isAnonComment ? '' : currentUserProfile.image
                    };
                    try {
                        await addDoc(commentsRef, commentData);
                        await updateDoc(postRef, { commentsCount: increment(1) });
                        commentInput.value = '';
                    } catch(error) { console.error("Erro ao enviar comentário:", error); }
                }
            }

            if (button.classList.contains('reply-comment-btn')) {
                const userName = button.dataset.userName;
                const commentInput = postElement.querySelector('.comment-input');
                commentInput.value = `@${userName} `;
                commentInput.focus();
            }

            if (button.classList.contains('delete-btn')) {
                if (!isMyPost || !isRegisteredUser) return;
                confirmationModalText.textContent = "Tem certeza que deseja apagar esta postagem?";
                deleteConfirmationModal.classList.remove('hidden');
                confirmationCallback = async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}/${postId}`));
                        postElement.remove();
                    } catch (error) { console.error("Erro ao apagar postagem:", error); }
                    finally { deleteConfirmationModal.classList.add('hidden'); }
                };
            }

            if (button.classList.contains('edit-btn')) {
                if (!isMyPost || !isRegisteredUser) return;
                editingPostId = { id: postId, collection: collectionName };
                const postDoc = await getDoc(postRef);
                const postData = postDoc.data();
                editPostContent.value = postData.content;
                editPostLink.value = postData.link || '';
                if(postData.postImage) {
                    editPostImagePreview.src = postData.postImage;
                    editPostImageContainer.classList.remove('hidden');
                } else {
                    editPostImageContainer.classList.add('hidden');
                }
                editPostModal.classList.remove('hidden');
            }
            
            if (button.classList.contains('delete-comment-btn')) {
                const commentId = button.dataset.commentId;
                confirmationModalText.textContent = "Tem certeza que deseja apagar este comentário?";
                deleteConfirmationModal.classList.remove('hidden');
                confirmationCallback = async () => {
                    const commentRef = doc(db, `artifacts/${appId}/public/data/${collectionName}/${postId}/comments/${commentId}`);
                    try {
                        await deleteDoc(commentRef);
                        await updateDoc(postRef, { commentsCount: increment(-1) });
                    } catch(error) { console.error("Erro ao apagar comentário:", error); }
                    finally { deleteConfirmationModal.classList.add('hidden'); }
                };
            }
            
            if (button.classList.contains('edit-comment-btn')) {
                const commentId = button.dataset.commentId;
                const commentContentText = button.closest('.flex').querySelector('p').textContent;
                editingComment = { postId, commentId, collection: collectionName };
                editCommentContent.value = commentContentText;
                editCommentModal.classList.remove('hidden');
            }
        });
        
        closeEditPostModal.addEventListener('click', () => { editPostModal.classList.add('hidden'); editingPostId = null; });
        saveEditedPost.addEventListener('click', async () => {
            if (editingPostId && userId) {
                const newContent = editPostContent.value.trim();
                const newLink = editPostLink.value.trim();
                const newImageFile = editPostImageFile.files[0];

                showSpinner(saveEditedPost);
                try {
                    const postRef = doc(db, `artifacts/${appId}/public/data/${editingPostId.collection}/${editingPostId.id}`);
                    const postDoc = await getDoc(postRef);
                    const postData = postDoc.data();
                    let newImageUrl = postData.postImage;

                    if (newImageFile) {
                        newImageUrl = await uploadImageToImgBB(newImageFile);
                    } else if (!editPostImageContainer.classList.contains('hidden') && !editPostImagePreview.src) {
                        newImageUrl = null;
                    }

                    await updateDoc(postRef, { 
                        content: newContent,
                        link: newLink || null,
                        postImage: newImageUrl
                    });
                    
                    editPostModal.classList.add('hidden');
                    editingPostId = null;
                } catch (error) { 
                    console.error("Erro ao salvar edição:", error); 
                } finally {
                    hideSpinner(saveEditedPost);
                }
            }
        });
        
        closeEditCommentModal.addEventListener('click', () => { editCommentModal.classList.add('hidden'); editingComment = null; });
        saveEditedComment.addEventListener('click', async () => {
            if (editingComment && userId) {
                const newContent = editCommentContent.value.trim();
                if (newContent) {
                    try {
                        const commentRef = doc(db, `artifacts/${appId}/public/data/${editingComment.collection}/${editingComment.postId}/comments/${editingComment.commentId}`);
                        await updateDoc(commentRef, { content: newContent });
                        editCommentModal.classList.add('hidden');
                        editingComment = null;
                    } catch (error) { console.error("Erro ao salvar edição do comentário:", error); }
                }
            }
        });

        const loadUserPosts = (profileOwnerId) => {
            if (cardPageListeners.has('posts')) {
                cardPageListeners.get('posts')();
            }

            const userPostsFeed = document.getElementById('userPostsFeed');
            showSkeletonLoaders(userPostsFeed);
            userPostsEndMessage.classList.add('hidden');

            try {
                const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
                const q = query(postsRef, where('userId', '==', profileOwnerId));

                const unsubscribe = onSnapshot(q, async (snapshot) => {
                    userPostsFeed.innerHTML = '';
                    if (snapshot.empty) {
                        userPostsFeed.innerHTML = '<p class="text-center text-white text-opacity-50 py-8">Este usuário ainda não postou nada.</p>';
                    } else {
                        const userPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        userPosts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                        const postElements = await Promise.all(userPosts.map(postData => {
                            return createPostElement(postData, true);
                        }));
                        postElements.forEach(postElement => userPostsFeed.appendChild(postElement));
                    }
                    userPostsEndMessage.classList.remove('hidden');
                }, (error) => {
                    console.error("Error with real-time user posts listener:", error);
                    userPostsFeed.innerHTML = '<p class="text-center text-red-400 py-8">Erro ao carregar posts.</p>';
                });

                cardPageListeners.set('posts', unsubscribe);
            } catch (error) {
                console.error("Error setting up user posts listener:", error);
                userPostsFeed.innerHTML = '<p class="text-center text-red-400 py-8">Erro ao carregar posts.</p>';
            }
        };
        
        const openProfileCard = async (profileOwnerId) => {
            for (const unsubscribe of cardPageListeners.values()) {
                unsubscribe();
            }
            cardPageListeners.clear();

            currentProfileCardOwnerId = profileOwnerId;
            profileCardPage.scrollTo(0, 0);

            try {
                const profileRef = doc(db, `artifacts/${appId}/public/data/profiles/${profileOwnerId}`);
                
                const unsubscribeProfile = onSnapshot(profileRef, async (docSnap) => {
                    const profileData = docSnap.exists() ? docSnap.data() : {};
                    
                    const isVerified = profileData.isVerified === true;
                    const verificationSealHtml = isVerified ? `<img src="${verificationSealUrl}" alt="Verificado" class="verification-seal">` : '';

                    cardHeaderImage.src = profileData.headerImage || 'https://placehold.co/1024x200/1C1C1C/FFFFFF?text=';
                    const cardProfileUrl = profileData.profileCardImage || profileData.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?';
                    cardProfileImage.src = cardProfileUrl;
                    cardProfileImage.classList.toggle('hidden', !cardProfileUrl);
                    cardProfilePlaceholder.classList.toggle('hidden', !!cardProfileUrl);
                    cardProfileName.innerHTML = `${profileData.name || 'Usuário'} ${verificationSealHtml}`;
                    cardUsernameTop.textContent = profileData.username ? `@${profileData.username}` : (profileData.name || 'Usuário');
                    cardBio.textContent = profileData.bio || '';
                    
                    socialLinksContainer.innerHTML = '';
                    if (profileData.instagram) {
                        socialLinksContainer.innerHTML += `<a href="https://instagram.com/${profileData.instagram}" target="_blank" class="text-2xl hover:text-pink-500"><i class="fab fa-instagram"></i></a>`;
                    }
                    if (profileData.tiktok) {
                        socialLinksContainer.innerHTML += `<a href="https://tiktok.com/${profileData.tiktok}" target="_blank" class="text-2xl hover:text-white"><i class="fab fa-tiktok"></i></a>`;
                    }

                    const setDetail = (element, label, value) => {
                         if (value) {
                             element.innerHTML = `<strong>${label}:</strong> ${value}`;
                             element.classList.remove('hidden');
                         } else {
                             element.classList.add('hidden');
                         }
                    };
                    setDetail(cardPronouns, 'Pronomes', profileData.pronouns);
                    setDetail(cardGender, 'Gênero', profileData.gender);
                    setDetail(cardSexuality, 'Sexualidade', profileData.sexuality);
                    setDetail(cardAge, 'Idade', profileData.age ? `${profileData.age} anos` : '');
                    setDetail(cardZodiac, 'Signo', profileData.zodiac);
                    setDetail(cardRelationshipStatus, 'Status', profileData.relationshipStatus);
                    setDetail(cardPersonality, 'Personalidade', profileData.personality);
                    
                    const photos = profileData.additionalPhotos || [];
                    const photosWrapper = document.getElementById('photosWrapper');
                    photosWrapper.innerHTML = '';
                    if (photos.length > 0) {
                        photos.forEach(photoUrl => {
                            const img = document.createElement('img');
                            img.src = photoUrl;
                            img.className = 'w-full aspect-square object-cover rounded-lg cursor-pointer';
                            img.addEventListener('click', () => {
                                lightboxImage.src = photoUrl;
                                lightboxModal.style.display = 'flex';
                            });
                            photosWrapper.appendChild(img);
                        });
                        additionalPhotosContainer.classList.remove('hidden');
                    } else {
                        additionalPhotosContainer.classList.add('hidden');
                    }
                });
                cardPageListeners.set('profile', unsubscribeProfile);

                if (isRegisteredUser && currentProfileCardOwnerId !== userId) {
                    const followingRef = doc(db, `artifacts/${appId}/users/${userId}/following/${currentProfileCardOwnerId}`);
                    const unsubscribeFollow = onSnapshot(followingRef, (docSnap) => {
                        if (docSnap.exists()) {
                            followButton.innerHTML = `<i class="fas fa-user-check mr-2"></i> Seguindo`;
                            followButton.className = 'w-full max-w-xs mx-auto mt-4 bg-white bg-opacity-10 text-white font-semibold py-3 rounded-xl transition-all hover:bg-opacity-20 active:scale-95';
                        } else {
                            followButton.innerHTML = `<i class="fas fa-user-plus mr-2"></i> Seguir`;
                            followButton.className = 'w-full max-w-xs mx-auto mt-4 bg-white text-black font-semibold py-3 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95';
                        }
                        followButton.classList.remove('hidden');
                    });
                    cardPageListeners.set('follow', unsubscribeFollow);
                } else {
                    followButton.classList.add('hidden');
                }


                const followerRef = collection(db, `artifacts/${appId}/users/${profileOwnerId}/followers`);
                const unsubscribeFollower = onSnapshot(followerRef, (snapshot) => {
                    followerCount.textContent = snapshot.size;
                }, (error) => console.error("Erro ao carregar seguidores:", error));
                cardPageListeners.set('followers', unsubscribeFollower);

                const userPostsRef = collection(db, `artifacts/${appId}/public/data/posts`);
                const userPostsQuery = query(userPostsRef, where('userId', '==', profileOwnerId));
                const userPostsCountSnap = await getCountFromServer(userPostsQuery);
                postCount.textContent = userPostsCountSnap.data().count;

                profileCardPage.classList.remove('hidden');
                
                showCardTab('feed', profileOwnerId);

            } catch(error) { console.error("Erro ao carregar card de perfil:", error); }
        };

        const showCardTab = (tabName, profileOwnerId) => {
            currentCardTab = tabName;
            cardFeedTab.classList.remove('border-white', 'text-white');
            cardFeedTab.classList.add('border-transparent', 'text-gray-400');
            cardPostsTab.classList.remove('border-white', 'text-white');
            cardPostsTab.classList.add('border-transparent', 'text-gray-400');

            if (tabName === 'feed') {
                cardFeedTab.classList.add('border-white', 'text-white');
                cardFeedContent.classList.remove('hidden');
                cardPostsContent.classList.add('hidden');
            } else if (tabName === 'posts') {
                cardPostsTab.classList.add('border-white', 'text-white');
                cardPostsContent.classList.remove('hidden');
                cardFeedContent.classList.add('hidden');
                loadUserPosts(profileOwnerId);
            }
        };

        cardFeedTab.addEventListener('click', () => showCardTab('feed', currentProfileCardOwnerId));
        cardPostsTab.addEventListener('click', () => showCardTab('posts', currentProfileCardOwnerId));
        
        document.body.addEventListener('click', async (e) => {
            const profileLink = e.target.closest('.profile-link');
            if (profileLink && !profileLink.disabled) {
                const profileOwnerId = profileLink.dataset.userId;
                if (profileOwnerId) openProfileCard(profileOwnerId);
                searchModal.classList.add('hidden');
            }
        });

        closeProfileCardPage.addEventListener('click', () => {
            profileCardPage.classList.add('hidden');
            
            for (const unsubscribe of cardPageListeners.values()) {
                unsubscribe();
            }
            cardPageListeners.clear();

            currentProfileCardOwnerId = null;
            userPostsFeed.innerHTML = '';
            cardFeedContent.classList.remove('hidden');
            cardPostsContent.classList.add('hidden');
            try {
                history.replaceState(null, "", window.location.pathname);
            } catch (e) {
                console.warn("Não foi possível limpar os parâmetros da URL devido a restrições de segurança:", e);
            }
        });
        
        followButton.addEventListener('click', async () => {
            if (!isRegisteredUser || !currentProfileCardOwnerId || userId === currentProfileCardOwnerId) return;
            followButton.disabled = true;
            
            const followingRef = doc(db, `artifacts/${appId}/users/${userId}/following/${currentProfileCardOwnerId}`);
            const followerRef = doc(db, `artifacts/${appId}/users/${currentProfileCardOwnerId}/followers/${userId}`);

            try {
                const followingSnap = await getDoc(followingRef);
                
                if (followingSnap.exists()) {
                    await deleteDoc(followingRef);
                    await deleteDoc(followerRef);
                } else {
                    await setDoc(followingRef, { timestamp: serverTimestamp() });
                    await setDoc(followerRef, { timestamp: serverTimestamp() });
                }
            } catch (error) {
                console.error("Erro ao seguir/parar de seguir:", error);
            } finally {
                followButton.disabled = false;
            }
        });
        
        followersButton.addEventListener('click', async () => {
            if (!currentProfileCardOwnerId) return;
            followersModalTitle.textContent = 'Seguidores';
            followersList.innerHTML = '<div class="spinner mx-auto"></div>';
            followersModal.classList.remove('hidden');

            try {
                const followersColRef = collection(db, `artifacts/${appId}/users/${currentProfileCardOwnerId}/followers`);
                const snapshot = await getDocs(followersColRef);
                
                if (snapshot.empty) {
                    followersList.innerHTML = '<p class="text-center text-white text-opacity-50">Nenhum seguidor ainda.</p>';
                    return;
                }

                followersList.innerHTML = '';
                for (const doc of snapshot.docs) {
                    const followerId = doc.id;
                    const profileData = await getCachedUserProfile(followerId);
                    const isVerified = profileData.isVerified === true;
                    const verificationSealHtml = isVerified ? `<img src="${verificationSealUrl}" alt="Verificado" class="verification-seal">` : '';
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'flex items-center p-2 rounded-lg hover:bg-white hover:bg-opacity-10 cursor-pointer follower-profile-link';
                    userElement.dataset.userId = followerId;

                    userElement.innerHTML = `
                        <img src="${profileData.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?'}" class="w-10 h-10 rounded-full object-cover mr-3">
                        <div>
                            <p class="font-semibold text-sm flex items-center">${profileData.name || 'Usuário'} ${verificationSealHtml}</p>
                            <p class="text-xs text-white text-opacity-50">${profileData.username ? '@' + profileData.username : ''}</p>
                        </div>
                    `;
                    followersList.appendChild(userElement);
                }
            } catch (error) {
                console.error("Erro ao buscar seguidores:", error);
                followersList.innerHTML = '<p class="text-center text-red-400">Não foi possível carregar os seguidores.</p>';
            }
        });

        closeFollowersModal.addEventListener('click', () => {
            followersModal.classList.add('hidden');
        });

        followersList.addEventListener('click', (e) => {
             const profileLink = e.target.closest('.follower-profile-link');
            if (profileLink) {
                const profileOwnerId = profileLink.dataset.userId;
                if (profileOwnerId) {
                    followersModal.classList.add('hidden');
                    closeProfileCardPage.click();
                    setTimeout(() => openProfileCard(profileOwnerId), 100);
                }
            }
        });

        editProfileCardButton.addEventListener('click', async () => {
            if (!isRegisteredUser) return;
            const profileCardRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);
            try {
                const profileCardSnap = await getDoc(profileCardRef);
                const profileCardData = profileCardSnap.exists() ? profileCardSnap.data() : {};
                
                editCardHeaderPreview.src = profileCardData.headerImage || 'https://placehold.co/1024x200/1C1C1C/FFFFFF?text=';
                editCardProfilePreview.src = profileCardData.profileCardImage || currentUserProfile.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?';
                editCardBio.value = profileCardData.bio || '';
                editCardPronouns.value = profileCardData.pronouns || '';
                editCardGender.value = profileCardData.gender || '';
                editCardSexuality.value = profileCardData.sexuality || '';
                editCardAge.value = profileCardData.age || '';
                editCardRelationship.value = profileCardData.relationshipStatus || '';
                editCardZodiac.value = profileCardData.zodiac || '';
                editCardPersonality.value = profileCardData.personality || '';
                editCardInstagram.value = profileCardData.instagram || '';
                editCardTiktok.value = profileCardData.tiktok || '';

                const photosGrid = document.getElementById('editCardPhotosGrid');
                photosGrid.innerHTML = '';
                const photoLimit = 5; // Alterado para o novo limite de 5
                for (let i = 0; i < photoLimit; i++) {
                    const photoUrl = profileCardData.additionalPhotos && profileCardData.additionalPhotos[i] ? profileCardData.additionalPhotos[i] : '';
                    const photoInputHTML = `
                        <label class="w-full h-24 bg-white bg-opacity-10 rounded-lg cursor-pointer flex items-center justify-center hover:bg-opacity-20 transition-colors relative overflow-hidden">
                            <img id="photoPreview${i+1}" src="${photoUrl}" class="absolute w-full h-full object-cover ${photoUrl ? '' : 'hidden'}">
                            <i class="fas fa-plus text-white ${photoUrl ? 'hidden' : ''}"></i>
                            <input id="editCardPhoto${i+1}" type="file" accept="image/*" class="hidden" data-preview="photoPreview${i+1}">
                        </label>`;
                    photosGrid.insertAdjacentHTML('beforeend', photoInputHTML);
                }
                
                editProfileCardPage.classList.remove('hidden');
                closeMenu();
            } catch (error) { console.error("Erro ao carregar dados do card de perfil para edição:", error); }
        });
        
        backFromEditCardPage.addEventListener('click', () => { editProfileCardPage.classList.add('hidden'); });
        
        document.body.addEventListener('change', (e) => {
            if (e.target.matches('#editCardHeaderFile, #editCardProfileFile, input[id^="editCardPhoto"]')) {
                const file = e.target.files[0];
                const previewId = e.target.dataset.preview;
                const previewElement = document.getElementById(previewId);
                if (file && previewElement) { 
                    const reader = new FileReader(); 
                    reader.onload = (event) => {
                        previewElement.src = event.target.result;
                        previewElement.classList.remove('hidden');
                        if (previewId.startsWith('photoPreview')) {
                            previewElement.nextElementSibling.classList.add('hidden');
                        }
                    };
                    reader.readAsDataURL(file); 
                }
            }
        });


        saveProfileCard.addEventListener('click', async () => {
            if (!isRegisteredUser) return;
            const age = parseInt(editCardAge.value);
            if (editCardAge.value && (isNaN(age) || age <= 0)) {
                cardUploadProgress.textContent = "A idade deve ser um número válido.";
                cardUploadProgress.classList.remove('hidden');
                setTimeout(() => cardUploadProgress.classList.add('hidden'), 3000);
                return;
            }
            showSpinner(saveProfileCard);
            cardUploadProgress.textContent = "Salvando card...";
            cardUploadProgress.classList.remove('hidden');
            
            const profileCardRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);
            try {
                const profileCardSnap = await getDoc(profileCardRef);
                const currentCardData = profileCardSnap.exists() ? profileCardSnap.data() : {};

                const uploadPromises = [];
                const photoInputs = document.querySelectorAll('#editCardPhotosGrid input[type="file"]');
                
                if (editCardHeaderFile.files[0]) uploadPromises.push(uploadImageToImgBB(editCardHeaderFile.files[0])); else uploadPromises.push(Promise.resolve(currentCardData.headerImage));
                if (editCardProfileFile.files[0]) uploadPromises.push(uploadImageToImgBB(editCardProfileFile.files[0])); else uploadPromises.push(Promise.resolve(currentCardData.profileCardImage));
                
                const existingPhotos = currentCardData.additionalPhotos || [];
                photoInputs.forEach((input, i) => {
                    if (input.files[0]) {
                        uploadPromises.push(uploadImageToImgBB(input.files[0]));
                    } else {
                        uploadPromises.push(Promise.resolve(existingPhotos[i] || null));
                    }
                });

                const uploadedUrls = await Promise.all(uploadPromises);
                
                const newCardData = {
                    bio: editCardBio.value.trim() || null,
                    pronouns: editCardPronouns.value.trim() || null,
                    gender: editCardGender.value || null, 
                    sexuality: editCardSexuality.value || null, 
                    age: age || null,
                    relationshipStatus: editCardRelationship.value || null,
                    zodiac: editCardZodiac.value.trim() || null,
                    personality: editCardPersonality.value.trim() || null,
                    instagram: editCardInstagram.value.trim() || null,
                    tiktok: editCardTiktok.value.trim() || null,
                    headerImage: uploadedUrls[0] || null,
                    profileCardImage: uploadedUrls[1] || null,
                    additionalPhotos: uploadedUrls.slice(2).filter(url => url),
                    userId,
                };

                await setDoc(profileCardRef, newCardData, { merge: true });
                cardUploadProgress.textContent = "Card salvo com sucesso!";
                setTimeout(() => { editProfileCardPage.classList.add('hidden'); }, 1000);
            } catch(error) {
                console.error("Erro ao salvar card:", error);
                cardUploadProgress.textContent = "Erro ao salvar. Tente novamente.";
            } finally {
                hideSpinner(saveProfileCard);
                setTimeout(() => cardUploadProgress.classList.add('hidden'), 2000);
            }
        });

        const copyToClipboard = (text) => {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const feedbackToast = document.getElementById('copyFeedback');
            feedbackToast.classList.remove('hidden');
            setTimeout(() => feedbackToast.classList.add('hidden'), 2000);
        };

        shareProfileButton.addEventListener('click', () => {
            if (currentProfileCardOwnerId) {
                const url = `${window.location.origin}${window.location.pathname}?user=${currentProfileCardOwnerId}`;
                copyToClipboard(url);
            }
        });

        document.body.addEventListener('click', (e) => {
            const shareBtn = e.target.closest('.share-post-btn');
            if (shareBtn) {
                const postId = shareBtn.dataset.id;
                const url = `${window.location.origin}${window.location.pathname}?post=${postId}`;
                copyToClipboard(url);
            }
        });

        const handleDirectLinks = async () => {
            const params = new URLSearchParams(window.location.search);
            const userIdParam = params.get('user');
            const postIdParam = params.get('post');

            if (userIdParam || postIdParam) {
                try {
                    history.replaceState(null, "", window.location.pathname);
                } catch (e) {
                    console.warn("Não foi possível limpar os parâmetros da URL devido a restrições de segurança:", e);
                }
            }

            if (userIdParam) {
                openProfileCard(userIdParam);
            } else if (postIdParam) {
                let postDoc;
                let isAnon = false;
                try {
                    postDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/posts/${postIdParam}`));
                    if (!postDoc.exists()) {
                        postDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/anonymous_posts/${postIdParam}`));
                        isAnon = true;
                    }
                } catch (e) { console.error("Error finding shared post", e); }
                
                if (postDoc && postDoc.exists()) {
                    const targetTab = isAnon ? 'anonymous' : 'feed';
                    if (currentTab !== targetTab) {
                        switchTab(targetTab);
                    }
                    
                    const interval = setInterval(() => {
                        const postElement = document.querySelector(`[data-post-id="${postIdParam}"]`);
                        if (postElement) {
                            clearInterval(interval);
                            postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            postElement.classList.add('post-highlight-shake');
                            if ("vibrate" in navigator) {
                                navigator.vibrate([100, 50, 100]);
                            }
                            setTimeout(() => { postElement.classList.remove('post-highlight-shake'); }, 1000);
                        }
                    }, 100);
                }
            }
        };

        draftsButton.addEventListener('click', async () => {
            if (!isRegisteredUser) return;
            draftsModal.classList.remove('hidden');
            draftsList.innerHTML = '<div class="text-center text-white text-opacity-50">Carregando rascunhos...</div>';
            const draftsRef = collection(db, `artifacts/${appId}/users/${userId}/drafts`);
            const q = query(draftsRef, orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                draftsList.innerHTML = '<div class="text-center text-white text-opacity-50">Nenhum rascunho encontrado.</div>';
            } else {
                draftsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const draft = doc.data();
                    const draftElement = document.createElement('div');
                    draftElement.className = 'p-3 bg-white bg-opacity-10 rounded-lg flex justify-between items-center';
                    draftElement.innerHTML = `
                        <p class="text-sm truncate pr-2">${draft.content || 'Rascunho com imagem'}</p>
                        <div class="flex-shrink-0">
                            <button class="edit-draft-btn p-1 text-white hover:text-white" data-id="${doc.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-draft-btn p-1 text-red-400 hover:text-red-500" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    draftsList.appendChild(draftElement);
                });
            }
            closeMenu();
        });

        closeDraftsModal.addEventListener('click', () => draftsModal.classList.add('hidden'));

        draftsList.addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const draftId = target.dataset.id;
            const draftRef = doc(db, `artifacts/${appId}/users/${userId}/drafts/${draftId}`);

            if (target.classList.contains('delete-draft-btn')) {
                await deleteDoc(draftRef);
                target.closest('div.p-3').remove();
            } else if (target.classList.contains('edit-draft-btn')) {
                const draftSnap = await getDoc(draftRef);
                const draft = draftSnap.data();
                postContent.value = draft.content || '';
                if(draft.postImage) {
                    postImagePreview.src = draft.postImage;
                    postImagePreviewContainer.classList.remove('hidden');
                    postFileName.textContent = 'Imagem carregada';
                }
                editingDraftId = draftId;
                draftsModal.classList.add('hidden');
                postModal.classList.remove('hidden');
            }
        });

        const showMainApp = (show) => {
            document.querySelector('header').style.display = show ? 'flex' : 'none';
            document.querySelector('nav').style.display = show ? 'flex' : 'none';
            document.getElementById('app-container').style.display = show ? 'flex' : 'none';
            postFab.style.display = show && isRegisteredUser ? 'flex' : 'none';
        };

        verificationButton.addEventListener('click', () => {
            if (!isRegisteredUser) {
                authModal.classList.remove('hidden');
                return;
            }
            showMainApp(false);
            verificationPage.classList.remove('hidden');
            checkVerificationStatus();
            closeMenu();
        });

        backFromVerificationPage.addEventListener('click', () => {
            showMainApp(true);
            verificationPage.classList.add('hidden');
        });

        verificationImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                verificationImageName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    verificationImagePreview.src = event.target.result;
                    verificationImagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                verificationImageName.textContent = 'Enviar uma foto para confirmação de identidade *';
                verificationImagePreviewContainer.classList.add('hidden');
                verificationImagePreview.src = '';
            }
        });


        submitVerificationRequest.addEventListener('click', async () => {
            const name = document.getElementById('verificationName').value.trim();
            const age = document.getElementById('verificationAge').value.trim();
            const whatsapp = document.getElementById('verificationWhatsapp').value.trim();
            const reason = document.getElementById('verificationReason').value.trim();
            const imageFile = verificationImageFile.files[0];

            if (!name || !age || !whatsapp || !reason || !imageFile) {
                 const customAlert = document.createElement('div');
                 customAlert.className = 'fixed inset-0 z-[100] bg-black bg-opacity-90 flex items-center justify-center';
                 customAlert.innerHTML = `
                        <div class="bg-black rounded-2xl p-6 w-11/12 sm:w-1/2 md:w-1/3 lg:w-1/4 flex flex-col items-center text-center space-y-4 border border-white border-opacity-20">
                            <p class="text-lg font-semibold">Preencha todos os campos obrigatórios (*).</p>
                            <button class="w-1/2 bg-white text-black py-2 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95" onclick="this.closest('.fixed').remove()">OK</button>
                        </div>
                    `;
                 document.body.appendChild(customAlert);
                 return;
            }

            showSpinner(submitVerificationRequest);
            
            try {
                let imageUrl = null;
                if (imageFile) {
                    imageUrl = await uploadImageToImgBB(imageFile);
                }

                const requestData = {
                    userId, name, age, whatsapp, reason,
                    timestamp: serverTimestamp(),
                    status: 'pending',
                    userImageUrl: imageUrl
                };
                
                const requestsRef = collection(db, `artifacts/${appId}/public/data/verificationRequests`);
                await addDoc(requestsRef, requestData);

                verificationFormContainer.classList.add('hidden');
                verificationStatusMessage.textContent = "Sua solicitação foi enviada. Aguarde a análise de um moderador.";
                verificationStatusMessage.classList.add('bg-yellow-500', 'bg-opacity-10', 'text-yellow-400');
                verificationStatusMessage.classList.remove('hidden', 'bg-red-500', 'text-red-400', 'bg-green-500', 'text-green-400');
            } catch (error) {
                console.error("Erro ao enviar solicitação:", error);
                const customAlert = document.createElement('div');
                customAlert.className = 'fixed inset-0 z-[100] bg-black bg-opacity-90 flex items-center justify-center';
                customAlert.innerHTML = `
                    <div class="bg-black rounded-2xl p-6 w-11/12 sm:w-1/2 md:w-1/3 lg:w-1/4 flex flex-col items-center text-center space-y-4 border border-white border-opacity-20">
                        <p class="text-lg font-semibold">Não foi possível enviar sua solicitação. Tente novamente.</p>
                        <button class="w-1/2 bg-white text-black py-2 rounded-xl transition-all hover:bg-white hover:bg-opacity-80 active:scale-95" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(customAlert);
            } finally {
                hideSpinner(submitVerificationRequest);
            }
        });

        const checkVerificationStatus = () => {
             if (!isRegisteredUser || !userId) {
                verificationPage.classList.add('hidden');
                return;
            }

            const requestsRef = collection(db, `artifacts/${appId}/public/data/verificationRequests`);
            const q = query(requestsRef, where('userId', '==', userId));

            onSnapshot(q, async (snapshot) => {
                const sortedDocs = snapshot.docs.sort((a, b) => (b.data().timestamp?.toMillis() || 0) - (a.data().timestamp?.toMillis() || 0));
                const requestDoc = sortedDocs[0];

                if (requestDoc && requestDoc.exists()) {
                    const status = requestDoc.data().status;
                    verificationFormContainer.classList.add('hidden');
                    verificationStatusMessage.classList.remove('hidden');
                    let message = '';
                    let colorClass = '';
                    switch (status) {
                        case 'pending':
                            message = 'Sua solicitação está pendente de aprovação.';
                            colorClass = 'bg-yellow-500 bg-opacity-10 text-yellow-400';
                            break;
                        case 'approved':
                            message = 'Sua solicitação foi aprovada! Você já possui o selo de verificação.';
                            colorClass = 'bg-green-500 bg-opacity-10 text-green-400';
                            verificationFormContainer.classList.remove('hidden');
                            break;
                        case 'rejected':
                            message = 'Sua solicitação foi recusada. Você pode enviar uma nova solicitação.';
                            colorClass = 'bg-red-500 bg-opacity-10 text-red-400';
                            verificationFormContainer.classList.remove('hidden');
                            break;
                        default:
                            message = 'Aguarde, um moderador irá analisar seu perfil.';
                            colorClass = 'bg-yellow-500 bg-opacity-10 text-yellow-400';
                            verificationFormContainer.classList.remove('hidden');
                            break;
                    }
                    verificationStatusMessage.textContent = message;
                    verificationStatusMessage.className = `text-center p-4 rounded-lg font-semibold ${colorClass}`;
                } else {
                    verificationStatusMessage.classList.add('hidden');
                    verificationFormContainer.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Erro ao verificar status:", error);
            });
        };

        const loadAdminPanel = () => {
            adminModal.classList.remove('hidden');
            showMainApp(false);
            
            pendingRequestsList.innerHTML = '<p class="text-center text-white text-opacity-50">Carregando...</p>';
            verifiedUsersList.innerHTML = '<p class="text-center text-white text-opacity-50">Carregando...</p>';

            if (pendingRequestsListener) pendingRequestsListener();
            const pendingRequestsRef = collection(db, `artifacts/${appId}/public/data/verificationRequests`);
            const pendingQ = query(pendingRequestsRef, where('status', '==', 'pending'));
            const unsubscribePending = onSnapshot(pendingQ, async (snapshot) => {
                pendingRequestsList.innerHTML = '';
                if (snapshot.empty) {
                    pendingRequestsList.innerHTML = '<p class="text-center text-white text-opacity-50">Nenhuma solicitação pendente.</p>';
                    return;
                }
                for (const docSnap of snapshot.docs) {
                    const request = docSnap.data();
                    const requestId = docSnap.id;
                    const userProfile = await getCachedUserProfile(request.userId);
                    const requestEl = document.createElement('div');
                    requestEl.className = 'bg-white bg-opacity-10 p-4 rounded-lg space-y-2';
                    requestEl.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <img src="${userProfile.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?'}" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <p class="font-semibold">${userProfile.name || 'Usuário'}</p>
                                <p class="text-xs text-white text-opacity-50">${userProfile.username ? '@' + userProfile.username : request.userId.substring(0,8) + '...'}</p>
                            </div>
                        </div>
                        <p class="text-sm text-white text-opacity-80"><strong>Nome:</strong> ${request.name}</p>
                        <p class="text-sm text-white text-opacity-80"><strong>Idade:</strong> ${request.age}</p>
                        <p class="text-sm text-white text-opacity-80"><strong>WhatsApp:</strong> ${request.whatsapp}</p>
                        <p class="text-sm text-white text-opacity-80"><strong>Motivo:</strong> ${request.reason}</p>
                        ${request.userImageUrl ? `<img src="${request.userImageUrl}" class="mt-2 w-full max-h-48 object-contain rounded-lg verification-image-clickable cursor-pointer" data-img-url="${request.userImageUrl}">` : ''}
                        <div class="flex space-x-2 mt-4">
                            <button class="flex-1 bg-green-500 text-white font-semibold py-2 rounded-xl transition-all hover:bg-green-600 accept-btn" data-id="${requestId}" data-user-id="${request.userId}">Aceitar</button>
                            <button class="flex-1 bg-red-500 text-white font-semibold py-2 rounded-xl transition-all hover:bg-red-600 reject-btn" data-id="${requestId}">Recusar</button>
                        </div>
                    `;
                    pendingRequestsList.appendChild(requestEl);
                }
            });
            pendingRequestsListener = unsubscribePending;

            if (verifiedUsersListener) verifiedUsersListener();
            const verifiedUsersRef = collection(db, `artifacts/${appId}/public/data/profiles`);
            const verifiedQ = query(verifiedUsersRef, where('isVerified', '==', true));
            const unsubscribeVerified = onSnapshot(verifiedQ, async (snapshot) => {
                verifiedUsersList.innerHTML = '';
                if (snapshot.empty) {
                    verifiedUsersList.innerHTML = '<p class="text-center text-white text-opacity-50">Nenhum usuário verificado.</p>';
                    return;
                }
                for (const docSnap of snapshot.docs) {
                    const userProfile = docSnap.data();
                    const userId = docSnap.id;
                    const userEl = document.createElement('div');
                    userEl.className = 'bg-white bg-opacity-10 p-3 rounded-lg flex justify-between items-center';
                    userEl.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <img src="${userProfile.image || 'https://placehold.co/200x200/000000/FFFFFF?text=?'}" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <p class="font-semibold">${userProfile.name || 'Usuário'}</p>
                                <p class="text-xs text-white text-opacity-50">${userProfile.username ? '@' + userProfile.username : ''}</p>
                            </div>
                        </div>
                        <button class="bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-xl hover:bg-red-600 revoke-btn" data-user-id="${userId}">Remover Selo</button>
                    `;
                    verifiedUsersList.appendChild(userEl);
                }
            });
            verifiedUsersListener = unsubscribeVerified;
        };

        submitVerificationCode.addEventListener('click', async () => {
            const code = verificationCodeInput.value.trim();
            if (code === 'ADMIN' && userId === ADMIN_UID) {
                loadAdminPanel();
                verificationCodeFeedback.textContent = '';
                verificationPage.classList.add('hidden');
                return;
            } else if (code === 'SEL0' && isRegisteredUser) {
                 try {
                     const profileRef = doc(db, `artifacts/${appId}/public/data/profiles/${userId}`);
                     await setDoc(profileRef, { isVerified: true }, { merge: true });
                     verificationCodeFeedback.textContent = "Parabéns! Você foi verificado.";
                     verificationCodeFeedback.className = "text-center text-sm mt-3 h-4 text-green-400";
                     await fetchUserProfile(userId);
                     updateAllUiWithProfileChange(userId);
                 } catch (error) {
                     console.error("Erro ao aplicar selo:", error);
                     verificationCodeFeedback.textContent = "Erro ao aplicar o selo.";
                     verificationCodeFeedback.className = "text-center text-sm mt-3 h-4 text-red-400";
                 }
            } else {
                 verificationCodeFeedback.textContent = "Código inválido. Tente novamente.";
                 verificationCodeFeedback.className = "text-center text-sm mt-3 h-4 text-red-400";
            }
            setTimeout(() => { verificationCodeFeedback.textContent = ''; }, 3000);
        });
        
        backFromAdminPage.addEventListener('click', () => {
            adminModal.classList.add('hidden');
            showMainApp(true);
            if (pendingRequestsListener) pendingRequestsListener();
            if (verifiedUsersListener) verifiedUsersListener();
        });
        
        refreshAdminData.addEventListener('click', () => {
            if (userId === ADMIN_UID) {
                loadAdminPanel();
            }
        });

        adminModal.addEventListener('click', async (e) => {
            const acceptBtn = e.target.closest('.accept-btn');
            const rejectBtn = e.target.closest('.reject-btn');
            const revokeBtn = e.target.closest('.revoke-btn');
            const verificationImage = e.target.closest('.verification-image-clickable');

            if (verificationImage) {
                 lightboxImage.src = verificationImage.dataset.imgUrl;
                 lightboxModal.style.display = 'flex';
                 return;
            }

            if (acceptBtn || rejectBtn) {
                const requestId = (acceptBtn || rejectBtn).dataset.id;
                const newStatus = acceptBtn ? 'approved' : 'rejected';
                const requestUserId = acceptBtn ? acceptBtn.dataset.userId : null;
                const requestRef = doc(db, `artifacts/${appId}/public/data/verificationRequests/${requestId}`);
                
                try {
                    await updateDoc(requestRef, { status: newStatus });
                    if (newStatus === 'approved' && requestUserId) {
                        const notificationsRef = collection(db, `artifacts/${appId}/users/${requestUserId}/notifications`);
                        await addDoc(notificationsRef, {
                            type: 'verification_approved',
                            timestamp: serverTimestamp(),
                            message: 'Sua solicitação de verificação foi aprovada! Clique para aceitar o selo.'
                        });
                        loadAdminPanel();
                    }
                } catch (error) {
                    console.error("Erro ao atualizar status:", error);
                }
            }

            if (revokeBtn) {
                const targetUserId = revokeBtn.dataset.userId;
                confirmationModalText.textContent = `Tem certeza que deseja remover o selo deste usuário?`;
                deleteConfirmationModal.classList.remove('hidden');
                confirmationCallback = async () => {
                    const profileRef = doc(db, `artifacts/${appId}/public/data/profiles/${targetUserId}`);
                    try {
                        await updateDoc(profileRef, { isVerified: false });
                        updateAllUiWithProfileChange(targetUserId);
                        loadAdminPanel();
                    } catch (error) {
                        console.error("Erro ao remover selo:", error);
                    } finally {
                        deleteConfirmationModal.classList.add('hidden');
                    }
                };
            }
        });

        notificationButton.addEventListener('click', () => {
            if (isRegisteredUser) {
                notificationModal.classList.remove('hidden');
                notificationBadge.classList.add('hidden');
                if (notificationList.innerHTML === '') {
                    notificationList.innerHTML = '<p class="text-center text-white text-opacity-50">Nenhuma notificação por enquanto.</p>';
                }
            } else {
                 authModal.classList.remove('hidden');
            }
        });

        closeNotificationModal.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
        });
        
        notificationList.addEventListener('click', async (e) => {
            const button = e.target.closest('.accept-notif-btn');
            if (!button) return;
            const notificationId = button.dataset.id;
            
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/notifications/${notificationId}`));
                
                await setDoc(doc(db, `artifacts/${appId}/public/data/profiles/${userId}`), { isVerified: true }, { merge: true });
                
                await fetchUserProfile(userId);
                updateAllUiWithProfileChange(userId);

                notificationModal.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao aceitar o selo pela notificação:", error);
            }
        });


        closeLightbox.addEventListener('click', () => {
            lightboxModal.style.display = 'none';
        });
        
        backToTopBtn.addEventListener('click', () => {
            feed.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        viewProfilePhoto.addEventListener('click', () => {
            lightboxImage.src = profileActionData.avatarUrl;
            lightboxModal.style.display = 'flex';
            profileActionModal.classList.add('hidden');
        });
        viewProfileCard.addEventListener('click', () => {
            openProfileCard(profileActionData.userId);
            profileActionModal.classList.add('hidden');
        });
        cancelProfileAction.addEventListener('click', () => {
            profileActionModal.classList.add('hidden');
        });

        aboutButton.addEventListener('click', () => {
            aboutDetails.classList.toggle('hidden');
            aboutButton.querySelector('i').classList.toggle('rotate-180');
        });

        settingsButton.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            closeMenu();
        });
        closeSettingsModal.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        changePasswordButton.addEventListener('click', () => { 
            changePasswordModal.classList.remove('hidden'); 
            settingsModal.classList.add('hidden');
        });
        deleteProfileButton.addEventListener('click', () => { 
            confirmationModalText.textContent = "Esta ação é irreversível e todos os seus dados e postagens serão apagados permanentemente.";
            deleteConfirmationModal.classList.remove('hidden');
            confirmationCallback = async () => {
                try { 
                    await deleteUser(auth.currentUser); 
                    deleteConfirmationModal.classList.add('hidden'); 
                } catch (error) { 
                    console.error("Erro ao excluir perfil:", error); 
                }
            };
            settingsModal.classList.add('hidden');
        });

        // New partnerships modal handlers
        partnershipsButton.addEventListener('click', () => {
            partnershipsModal.classList.remove('hidden');
            closeMenu();
        });
        closePartnershipsModal.addEventListener('click', () => {
            partnershipsModal.classList.add('hidden');
        });
        copyEmailButton.addEventListener('click', () => {
            copyToClipboard(partnershipEmail.textContent);
        });

        const particleCanvas = document.getElementById('particleCanvas');
        const ctx = particleCanvas.getContext('2d');
        let particles = [];
        let animationFrameId;

        const noiseSynth = new Tone.NoiseSynth({
            noise: { type: 'pink' },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 0.4 }
        });
        const lowpass = new Tone.Filter(1000, 'lowpass').toDestination();
        const volume = new Tone.Volume(-15).toDestination();
        noiseSynth.connect(lowpass);
        lowpass.connect(volume);

        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 5 + 2;
                this.color = ['#c00000', '#ff0000', '#ff4d4d', '#ffffff'][Math.floor(Math.random() * 4)];
                this.opacity = 1;
                const angle = Math.random() * 2 * Math.PI;
                const speed = Math.random() * 2 + 1;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.opacity -= 0.02;
                this.size *= 0.98;
            }
            draw() {
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].opacity <= 0.05 || particles[i].size <= 0.5) {
                    particles.splice(i, 1);
                }
            }
            if (particles.length > 0) {
                animationFrameId = requestAnimationFrame(animateParticles);
            } else {
                particleCanvas.style.display = 'none';
                cancelAnimationFrame(animationFrameId);
            }
        }

        async function triggerLikeAnimation(button) {
            const rect = button.getBoundingClientRect();
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
            particleCanvas.style.display = 'block';
            
            particles = [];
            const startX = rect.left + rect.width / 2;
            const startY = rect.top + rect.height / 2;

            for (let i = 0; i < 20; i++) {
                particles.push(new Particle(startX, startY));
            }

            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            noiseSynth.triggerAttackRelease(0.1);
            if ("vibrate" in navigator) {
                navigator.vibrate(100);
            }
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animateParticles();
        }


        window.onload = startApp;

    </script>

</body>
</html>
